<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisme Sales - CRM (Supabase)</title>
    
    <!-- INÍCIO: Tags para PWA e Ícones Personalizados -->
    <meta name="theme-color" content="#2fc36a">
    
    <!-- Favicons para Navegadores -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.png">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.ico">

    <!-- Ícone para "Adicionar à Tela de Início" no iOS -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/apple-touch-icon.png">

    <!-- Manifesto do PWA (agora linka para o arquivo externo) -->
    <link rel="manifest" href="manifest.json">
    <!-- FIM: Tags para PWA e Ícones Personalizados -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <!-- INÍCIO: Inclusão do Cliente Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- FIM: Inclusão do Cliente Supabase -->

    <style>
        /* --- ESTILOS GERAIS E MELHORIAS DE LAYOUT --- */
        html, body {
            height: 100%;
            overflow: hidden; /* Impede o scroll da página inteira */
            background-color: #f8fafc; /* slate-50 */
        }
        .kanban-board-container::-webkit-scrollbar { height: 8px; }
        .kanban-board-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .kanban-board-container::-webkit-scrollbar-thumb { background: #a3a3a3; border-radius: 4px; }
        
        /* --- ESTILOS DO QUADRO KANBAN (ESTILO TRELLO) --- */
        #kanban-board {
            height: calc(100vh - 73px); /* Altura do header em desktop */
            overflow-x: auto; /* Garante o scroll horizontal */
            overflow-y: hidden; /* Previne o scroll vertical no quadro */
        }
        @media (max-width: 767px) {
            #kanban-board { height: calc(100vh - 120px); } /* Altura do header em mobile */
        }
        .kanban-column {
            min-height: calc(100vh - 120px); /* Altura mínima das colunas */
        }
        .kanban-cards {
            max-height: calc(100vh - 200px); /* Altura máxima do container de cards */
            overflow-y: auto; /* Scroll vertical apenas nos cards */
        }
        .kanban-cards::-webkit-scrollbar { width: 6px; }
        .kanban-cards::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
        .kanban-cards::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .kanban-cards::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* --- ESTILOS DE ANIMAÇÃO E TRANSIÇÃO --- */
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .kanban-card { transition: all 0.2s ease; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .kanban-column.collapsed { width: 60px !important; }
        .kanban-column.collapsed .column-header-expanded { display: none !important; }
        .kanban-column.collapsed .column-header-collapsed { display: flex !important; }
        .kanban-column.collapsed .kanban-cards { display: none !important; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; }
        
        /* --- ESTILOS DO MODAL --- */
        .tab-button { @apply py-2 px-4 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300; }
        .tab-button.active { @apply text-green-600 border-green-500; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-badge { @apply bg-red-500 text-white text-xs rounded-full px-2 py-0.5 ml-2; }
        .form-input { @apply mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm; }
        
        /* --- ESTILOS PARA TAREFAS E TICKETS --- */
        .task-form-container { @apply bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300; }
        .task-form-expanded { @apply border-solid border-green-300 bg-green-50; }
        .task-title-input { @apply w-full px-3 py-2 border-0 bg-transparent text-lg font-semibold placeholder-gray-400 focus:outline-none; }
        .suggestion-btn { @apply px-3 py-1 text-xs bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors; }
        .task-item:hover .task-controls { opacity: 1; }
        
        /* --- ESTILOS DA VISUALIZAÇÃO EM LISTA --- */
        #list-view {
            height: calc(100vh - 73px);
            overflow: hidden;
        }
        
        .list-view-header {
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        
        .list-view-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .list-item:hover {
            border-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
        }
        
        .list-item-type {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .list-item-type.task {
            background-color: #dbeafe;
            color: #2563eb;
        }
        
        .list-item-type.ticket {
            background-color: #fed7aa;
            color: #ea580c;
        }
        
        .list-item-content {
            flex: 1;
            min-width: 0;
        }
        
        .list-item-title {
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .list-item-company {
            font-size: 0.875rem;
            color: #6b7280;
            display: flex;
            align-items: center;
        }
        
        .list-item-due {
            margin-right: 16px;
            text-align: right;
            flex-shrink: 0;
        }
        
        .list-item-responsible {
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        .list-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .list-item:hover .list-item-actions {
            opacity: 1;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn.complete {
            background-color: #dcfce7;
            color: #16a34a;
        }
        
        .action-btn.complete:hover {
            background-color: #bbf7d0;
        }
        
        .action-btn.edit {
            background-color: #dbeafe;
            color: #2563eb;
        }
        
        .action-btn.edit:hover {
            background-color: #bfdbfe;
        }
        
        .action-btn.delete {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .action-btn.delete:hover {
            background-color: #fecaca;
        }
        
        /* --- ESTILOS RESPONSIVOS --- */
        @media (max-width: 767px) {
            .list-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 16px;
            }
            
            .list-item-type {
                margin-bottom: 8px;
                margin-right: 0;
            }
            
            .list-item-content {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .list-item-due,
            .list-item-responsible {
                margin-right: 0;
                margin-bottom: 8px;
            }
            
            .list-item-actions {
                opacity: 1;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen bg-gradient-to-br from-green-400 to-blue-600 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Prisme Sales</h1>
                <p class="text-gray-600">Faça login para acessar seu CRM</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                    <input type="email" id="email" required class="form-input" placeholder="seu@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                    <input type="tel" id="telefone" required class="form-input" placeholder="(11) 99999-9999">
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    Entrar
                </button>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
            </form>
        </div>
    </div>

    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="min-h-screen bg-slate-50 flex items-center justify-center hidden">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-6xl text-green-500 mb-4"></i>
            <p class="text-xl text-gray-600">Carregando seu CRM...</p>
        </div>
    </div>

    <!-- Aplicação Principal -->
    <div id="crm-app" class="h-screen flex flex-col bg-slate-50 hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 px-4 py-3 flex-shrink-0">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-chart-line text-green-500 mr-2"></i>
                        Seu CRM
                    </h1>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Filtro por Tag -->
                    <div id="filter-container" class="relative">
                        <button id="filter-trigger-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <span id="filter-btn-text">TODOS</span>
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                        <div id="filter-popup" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-10 hidden">
                            <div id="filter-options-container" class="py-1"></div>
                        </div>
                    </div>
                    
                    <!-- Campo de Pesquisa -->
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Pesquisar por empresa..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <!-- Botão de Alternância de Visualização -->
                    <button id="view-toggle-btn" class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors" title="Alternar para Visão de Lista">
                        <i id="view-toggle-icon" class="fas fa-list-check text-lg"></i>
                    </button>
                    
                    <!-- Menu do Usuário -->
                    <div id="user-menu-container" class="relative">
                        <button id="user-avatar-btn" class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center hover:bg-green-600 transition-colors">
                            <img alt="Avatar"/>
                        </button>
                        <div id="logout-popup" class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-10 hidden">
                            <div class="p-4 border-b border-gray-200">
                                <p id="popup-user-name" class="font-semibold text-gray-800"></p>
                                <p id="popup-user-email" class="text-sm text-gray-600"></p>
                            </div>
                            <div class="py-1">
                                <a href="#" id="popup-logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-1 overflow-hidden">
            <!-- Visualização Kanban -->
            <div id="kanban-board" class="kanban-board-container h-full flex gap-4 p-4 overflow-x-auto overflow-y-hidden">
                <!-- Colunas do Kanban serão inseridas aqui -->
            </div>

            <!-- Visualização em Lista -->
            <div id="list-view" class="hidden flex flex-col">
                <!-- Cabeçalho da Lista com Filtros -->
                <div class="list-view-header">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Lista de Atividades</h2>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- Filtro de Tipo -->
                        <div class="relative">
                            <select id="list-filter-type" class="form-input !m-0 !py-1.5 !pl-3 !pr-8 appearance-none bg-slate-50">
                                <option value="all">Todos os Tipos</option>
                                <option value="task">Apenas Tarefas</option>
                                <option value="ticket">Apenas Tickets</option>
                            </select>
                        </div>
                        <!-- Filtro de Responsável -->
                        <div class="relative">
                            <select id="list-filter-responsible" class="form-input !m-0 !py-1.5 !pl-3 !pr-8 appearance-none bg-slate-50">
                                <option value="all">Todos os Responsáveis</option>
                                <!-- Opções de usuários serão inseridas aqui -->
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Container da Lista de Atividades -->
                <div class="list-view-content">
                    <div id="list-view-container">
                        <!-- Itens da lista serão inseridos aqui -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal do Cliente -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-20">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0"></div>
    </div>
    
    <!-- NOVO MODAL: Editor de Tarefa/Ticket -->
    <div id="item-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-30">
        <div id="item-editor-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <!-- Conteúdo do editor será injetado aqui -->
        </div>
    </div>

    <!-- Modal de Confirmação Genérico -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <p id="confirmation-message" class="text-lg text-gray-800 mb-6">Você tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">Cancelar</button>
                <button id="confirm-action-btn" class="px-6 py-2 rounded-full text-white bg-red-500 hover:bg-red-600 font-semibold">Confirmar</button>
            </div>
        </div>
    </div>
    
    <template id="loader-template"><div class="flex items-center justify-center h-full p-8"><i class="fas fa-spinner fa-spin text-4xl text-green-500"></i></div></template>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 z-40"></div>

    <script>
        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        const SUPABASE_URL = 'https://ccenxfyqwtfpexltuwrn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZW54Znlxd3RmcGV4bHR1d3JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzE1MTMsImV4cCI6MjA2ODg0NzUxM30.6un31sODuCyd5Dz_pR_kn656k74jjh5CNAfF0YteT7I';
        
        // Inicializar Supabase
        const dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const loginScreen = document.getElementById('login-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const crmApp = document.getElementById('crm-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const kanbanBoard = document.getElementById('kanban-board');
        const listView = document.getElementById('list-view');
        const clientModal = document.getElementById('client-modal');
        const modalContent = document.getElementById('modal-content');
        const searchInput = document.getElementById('search-input');
        const loaderTemplate = document.getElementById('loader-template');
        const toast = document.getElementById('toast');
        const viewToggleButton = document.getElementById('view-toggle-btn');
        const viewToggleIcon = document.getElementById('view-toggle-icon');
        
        let appData = {};
        let quillEditor = null;
        let itemQuillEditor = null;
        let currentUser = null;
        let deferredPrompt;
        let activeTagId = null;
        let currentView = 'kanban'; // 'kanban' ou 'list'
        let listFilterType = 'all';
        let listFilterResponsibleId = 'all';

        // --- FUNÇÕES DE UTILIDADE ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }

        // --- LÓGICA DE CONFIRMAÇÃO ---
        function showConfirmationModal(message, onConfirm) {
            const confirmationModal = document.getElementById('confirmation-modal');
            const messageEl = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirm-action-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            messageEl.textContent = message;

            const confirmHandler = () => {
                onConfirm();
                hideConfirmationModal();
            };

            const cancelHandler = () => {
                hideConfirmationModal();
            };
            
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));

            document.getElementById('confirm-action-btn').addEventListener('click', confirmHandler);
            document.getElementById('confirm-cancel-btn').addEventListener('click', cancelHandler);

            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }

        // --- LÓGICA DE AUTENTICAÇÃO E INICIALIZAÇÃO ---
        function showApp(isInitialLoad = false) {
            if (isInitialLoad) {
                loginScreen.classList.add('hidden');
                loadingScreen.classList.remove('hidden');
            }
            
            const userAvatarBtn = document.getElementById('user-avatar-btn');
            userAvatarBtn.innerHTML = '';
            const userInitial = currentUser.nome_usuario ? currentUser.nome_usuario.charAt(0).toUpperCase() : '?';
            
            const fallback = document.createElement('span');
            fallback.className = 'text-lg';
            fallback.textContent = userInitial;

            if (currentUser.foto_url) {
                const img = document.createElement('img');
                img.src = currentUser.foto_url;
                img.crossOrigin = "anonymous";
                img.referrerPolicy = "no-referrer";
                img.className = 'w-full h-full rounded-full object-cover';
                img.alt = 'Avatar';
                img.onerror = () => {
                    userAvatarBtn.innerHTML = '';
                    userAvatarBtn.appendChild(fallback);
                };
                userAvatarBtn.appendChild(img);
            } else {
                userAvatarBtn.appendChild(fallback);
            }
            
            document.getElementById('popup-user-name').textContent = currentUser.nome_usuario;
            document.getElementById('popup-user-email').textContent = currentUser.email;
            
            initializeApp();
        }

        function showLogin() {
            localStorage.removeItem('crmUser');
            currentUser = null;
            crmApp.classList.add('hidden');
            loadingScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const telefone = document.getElementById('telefone').value;
            
            try {
                const { data, error } = await dbClient
                    .from('usuarios')
                    .select('*')
                    .eq('email', email)
                    .eq('telefone', telefone)
                    .single();

                if (error || !data) {
                    loginError.textContent = 'Email ou senha incorretos';
                    loginError.classList.remove('hidden');
                } else {
                    currentUser = data;
                    localStorage.setItem('crmUser', JSON.stringify(currentUser));
                    showApp(true);
                }
            } catch (err) {
                loginError.textContent = 'Erro ao fazer login: ' + err.message;
                loginError.classList.remove('hidden');
            }
        });

        async function initializeApp() {
            try {
                // Carregar dados do Supabase
                const [clientsResult, tasksResult, ticketsResult, usersResult, tagsResult, clientTagsResult, statusesResult] = await Promise.all([
                    dbClient.from('clientes').select('*'),
                    dbClient.from('tarefas').select('*'),
                    dbClient.from('tickets').select('*'),
                    dbClient.from('usuarios').select('*'),
                    dbClient.from('tags').select('*'),
                    dbClient.from('cliente_tags').select('*'),
                    dbClient.from('status').select('*')
                ]);

                // Verificar erros
                const results = [clientsResult, tasksResult, ticketsResult, usersResult, tagsResult, clientTagsResult, statusesResult];
                for (const res of results) {
                    if (res.error) throw res.error;
                }

                appData = {
                    clients: clientsResult.data || [],
                    tasks: tasksResult.data || [],
                    tickets: ticketsResult.data || [],
                    users: usersResult.data || [],
                    tags: tagsResult.data || [],
                    client_tags: clientTagsResult.data || [],
                    statuses: statusesResult.data || [
                        { nome_status: 'KickOFF', ordem: 1 },
                        { nome_status: 'Implementação', ordem: 2 },
                        { nome_status: 'Primeiros 90 dias', ordem: 3 },
                        { nome_status: 'Manutenção', ordem: 4 }
                    ]
                };

                loadingScreen.classList.add('hidden');
                crmApp.classList.remove('hidden');

                setupFilterLogic();
                setupUserMenu();
                setupViewToggle();
                setupRealtimeSubscriptions();
                applyFiltersAndRender();
            } catch (error) {
                loadingScreen.classList.add('hidden');
                crmApp.classList.remove('hidden');
                kanbanBoard.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg"><b>Erro:</b> ${error.message}</div>`;
                console.error('Erro na inicialização:', error);
            }
        }

        // --- LÓGICA DE TEMPO REAL (REALTIME) ---
        function setupRealtimeSubscriptions() {
            console.log("Configurando inscrições de tempo real...");
            dbClient.channel('public-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'clientes' }, p => handleRealtimeChange(p, 'clients', 'id_cliente'))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tarefas' }, p => handleRealtimeChange(p, 'tasks', 'id_tarefa'))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, p => handleRealtimeChange(p, 'tickets', 'id_ticket'))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'cliente_tags' }, payload => {
                    console.log('Alteração em cliente_tags:', payload);
                    const { eventType, new: newRecord, old: oldRecord } = payload;
                    if (eventType === 'INSERT') appData.client_tags.push(newRecord);
                    if (eventType === 'DELETE') {
                        appData.client_tags = appData.client_tags.filter(ct => !(ct.id_cliente === oldRecord.id_cliente && ct.id_tag === oldRecord.id_tag));
                    }
                    applyFiltersAndRender();
                })
                .subscribe();
        }

        function handleRealtimeChange(payload, appDataKey, idKey) {
            console.log(`Alteração em ${appDataKey}:`, payload);
            const { eventType, new: newRecord, old: oldRecord } = payload;
            switch (eventType) {
                case 'INSERT':
                    appData[appDataKey].push(newRecord);
                    break;
                case 'UPDATE':
                    const indexToUpdate = appData[appDataKey].findIndex(item => item[idKey] === newRecord[idKey]);
                    if (indexToUpdate !== -1) appData[appDataKey][indexToUpdate] = newRecord;
                    else appData[appDataKey].push(newRecord);
                    break;
                case 'DELETE':
                    const oldId = oldRecord[idKey];
                    appData[appDataKey] = appData[appDataKey].filter(item => item[idKey] !== oldId);
                    break;
            }
            applyFiltersAndRender();
        }

        // --- LÓGICA DE FILTRAGEM E RENDERIZAÇÃO ---
        function getFilteredClients() {
            let filteredClients = appData.clients;

            if (activeTagId) {
                const clientIdsWithTag = appData.client_tags
                    .filter(ct => ct.id_tag === activeTagId)
                    .map(ct => ct.id_cliente);
                
                filteredClients = appData.clients.filter(client => clientIdsWithTag.includes(client.id_cliente));
            }

            const searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm.length >= 3) {
                filteredClients = filteredClients.filter(client => 
                    client.nome_empresa.toLowerCase().includes(searchTerm)
                );
            }
            return filteredClients;
        }

        function applyFiltersAndRender() {
            if (currentView === 'kanban') {
                const clientList = getFilteredClients();
                renderBoard(clientList);
            } else {
                renderListView();
            }
        }

        function setupFilterLogic() {
            const filterContainer = document.getElementById('filter-container');
            const triggerBtn = document.getElementById('filter-trigger-btn');
            const popup = document.getElementById('filter-popup');
            const optionsContainer = document.getElementById('filter-options-container');
            const btnText = document.getElementById('filter-btn-text');

            optionsContainer.innerHTML = '';

            if (appData.tags) {
                appData.tags.forEach(tag => {
                    const option = document.createElement('a');
                    option.href = '#';
                    option.className = 'filter-tag-option text-gray-700 block px-4 py-2 text-sm';
                    option.dataset.tagId = tag.id_tag;
                    option.dataset.tagName = tag.nome_tag;
                    option.dataset.tagColor = tag.cor;
                    
                    option.innerHTML = `
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-3" style="background-color: ${tag.cor};"></span>
                            <span>${tag.nome_tag}</span>
                        </div>
                    `;

                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = e.currentTarget;
                        activeTagId = target.dataset.tagId;

                        btnText.textContent = target.dataset.tagName;
                        triggerBtn.style.backgroundColor = `${target.dataset.tagColor}20`;
                        triggerBtn.style.color = target.dataset.tagColor;
                        triggerBtn.style.borderColor = target.dataset.tagColor;
                        triggerBtn.dataset.activeTagId = activeTagId;

                        popup.classList.add('hidden');
                        applyFiltersAndRender();
                    });

                    optionsContainer.appendChild(option);
                });
            }

            triggerBtn.addEventListener('click', () => {
                if (triggerBtn.dataset.activeTagId) {
                    activeTagId = null;
                    triggerBtn.dataset.activeTagId = '';
                    btnText.textContent = 'TODOS';
                    triggerBtn.style.backgroundColor = 'white';
                    triggerBtn.style.color = '#374151';
                    triggerBtn.style.borderColor = '#D1D5DB';
                    applyFiltersAndRender();
                } else {
                    popup.classList.toggle('hidden');
                }
            });
        }
        
        function setupUserMenu() {
            const userMenuContainer = document.getElementById('user-menu-container');
            const userAvatarBtn = document.getElementById('user-avatar-btn');
            const logoutPopup = document.getElementById('logout-popup');
            const popupLogoutBtn = document.getElementById('popup-logout-btn');
            
            userAvatarBtn.addEventListener('click', () => logoutPopup.classList.toggle('hidden'));
            popupLogoutBtn.addEventListener('click', (e) => { 
                e.preventDefault(); 
                logoutPopup.classList.add('hidden'); 
                showLogin(); 
            });
            
            document.addEventListener('click', (e) => {
                if (!userMenuContainer.contains(e.target)) logoutPopup.classList.add('hidden');
                if (!document.getElementById('filter-container').contains(e.target)) document.getElementById('filter-popup').classList.add('hidden');
            });
        }

        function setupViewToggle() {
            viewToggleButton.addEventListener('click', () => {
                if (currentView === 'kanban') {
                    currentView = 'list';
                    kanbanBoard.classList.add('hidden');
                    listView.classList.remove('hidden');
                    viewToggleIcon.className = 'fas fa-table-columns text-lg';
                    viewToggleButton.title = 'Alternar para Visão Kanban';
                    populateListViewFilters();
                    renderListView();
                } else {
                    currentView = 'kanban';
                    listView.classList.add('hidden');
                    kanbanBoard.classList.remove('hidden');
                    viewToggleIcon.className = 'fas fa-list-check text-lg';
                    viewToggleButton.title = 'Alternar para Visão de Lista';
                    applyFiltersAndRender();
                }
            });
        }

        function populateListViewFilters() {
            const typeFilter = document.getElementById('list-filter-type');
            const responsibleFilter = document.getElementById('list-filter-responsible');

            // Configurar filtro de tipo
            if (!typeFilter.getAttribute('data-listener-added')) {
                typeFilter.addEventListener('change', (e) => {
                    listFilterType = e.target.value;
                    renderListView();
                });
                typeFilter.setAttribute('data-listener-added', 'true');
            }

            // Configurar filtro de responsável
            if (!responsibleFilter.getAttribute('data-listener-added')) {
                responsibleFilter.innerHTML = '<option value="all">Todos os Responsáveis</option>';
                appData.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id_usuario;
                    option.textContent = user.nome_usuario;
                    responsibleFilter.appendChild(option);
                });

                responsibleFilter.addEventListener('change', (e) => {
                    listFilterResponsibleId = e.target.value;
                    renderListView();
                });
                responsibleFilter.setAttribute('data-listener-added', 'true');
            }
        }

        function renderListView() {
            const container = document.getElementById('list-view-container');
            container.innerHTML = '<div class="flex items-center justify-center p-8"><i class="fas fa-spinner fa-spin text-4xl text-green-500"></i></div>';

            // 1. Obter todas as tarefas e tickets abertos
            const openTasks = (appData.tasks || []).filter(t => !t.concluido).map(t => ({
                ...t, 
                type: 'task', 
                id: t.id_tarefa, 
                title: t.titulo_tarefa,
                clientId: t.id_cliente,
                responsibleId: t.responsavel_id,
                dueDate: t.prazo_final
            }));
            
            const openTickets = (appData.tickets || []).filter(t => !t.concluido).map(t => ({
                ...t, 
                type: 'ticket', 
                id: t.id_ticket, 
                title: t.titulo_ticket,
                clientId: t.id_cliente,
                responsibleId: t.responsavel_id,
                dueDate: t.prazo_final
            }));
            
            let combinedList = [...openTasks, ...openTickets];

            // 2. Aplicar filtros globais (empresa e tag)
            const visibleClientIds = getFilteredClients().map(c => c.id_cliente);
            combinedList = combinedList.filter(item => visibleClientIds.includes(item.clientId));

            // 3. Aplicar filtros da lista (tipo e responsável)
            if (listFilterType !== 'all') {
                combinedList = combinedList.filter(item => item.type === listFilterType);
            }
            if (listFilterResponsibleId !== 'all') {
                combinedList = combinedList.filter(item => item.responsibleId === listFilterResponsibleId);
            }

            // 4. Ordenar a lista por prazo
            combinedList.sort((a, b) => {
                const aHasDate = !!a.dueDate;
                const bHasDate = !!b.dueDate;
                if (!aHasDate && bHasDate) return 1;
                if (aHasDate && !bHasDate) return -1;
                if (!aHasDate && !bHasDate) return 0;
                return new Date(a.dueDate) - new Date(b.dueDate);
            });

            // 5. Renderizar o HTML
            if (combinedList.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-8 p-4">Nenhuma atividade encontrada com os filtros atuais.</div>';
                return;
            }

            const listHtml = combinedList.map(item => {
                const client = appData.clients.find(c => c.id_cliente === item.clientId);
                const responsibleUser = appData.users.find(u => u.id_usuario === item.responsibleId);
                const timeInfo = formatTimeRemaining(item.dueDate);

                let avatarHtml = `<div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 text-sm"><i class="fas fa-user"></i></div>`;
                if (responsibleUser) {
                    if (responsibleUser.foto_url) {
                        avatarHtml = `<img src="${responsibleUser.foto_url}" alt="${responsibleUser.nome_usuario}" class="w-8 h-8 rounded-full object-cover" crossorigin="anonymous" referrerpolicy="no-referrer">`;
                    } else {
                        const initial = responsibleUser.nome_usuario ? responsibleUser.nome_usuario.charAt(0).toUpperCase() : '?';
                        avatarHtml = `<div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-sm">${initial}</div>`;
                    }
                }

                const iconClass = item.type === 'task' ? 'fa-check-square' : 'fa-ticket';
                const typeClass = item.type === 'task' ? 'task' : 'ticket';

                return `
                    <div class="list-item">
                        <div class="list-item-type ${typeClass}">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <div class="list-item-content">
                            <div class="list-item-title">${item.title}</div>
                            <div class="list-item-company">
                                <i class="far fa-building mr-1"></i>
                                ${client ? client.nome_empresa : 'Cliente não encontrado'}
                            </div>
                        </div>
                        <div class="list-item-due">
                            <div class="text-sm font-medium ${timeInfo.colorClass} ${timeInfo.pulse ? 'pulse-animation' : ''}">
                                ${timeInfo.text}
                            </div>
                        </div>
                        <div class="list-item-responsible">
                            ${avatarHtml}
                        </div>
                        <div class="list-item-actions">
                            <button class="action-btn complete" onclick="handleQuickComplete('${item.type}', '${item.id}')" title="Marcar como Concluída">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="action-btn edit" onclick="openItemEditorModal('${item.type}', '${item.id}')" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = listHtml;
        }

        // --- RENDERIZAÇÃO DO QUADRO KANBAN ---
        function renderBoard(clientList = []) {
            kanbanBoard.innerHTML = '';
            appData.statuses.sort((a, b) => a.ordem - b.ordem).forEach(status => {
                const column = document.createElement('div');
                column.className = 'kanban-column bg-slate-100 rounded-lg p-3 w-[90vw] md:w-80 flex-shrink-0 transition-all duration-300';
                const clientsInStatus = clientList.filter(c => c.status === status.nome_status);

                column.innerHTML = `
                    <div class="column-header-expanded flex justify-between items-center mb-3 flex-shrink-0">
                        <div class="flex items-center min-w-0">
                            <h2 class="font-bold text-gray-700 truncate">${status.nome_status}</h2>
                            <span class="ml-2 bg-slate-200 text-slate-600 text-sm font-semibold rounded-full px-2">${clientsInStatus.length}</span>
                        </div>
                        <button class="collapse-btn text-gray-400 hover:text-gray-600">
                            <i class="fa-solid fa-angles-left"></i>
                        </button>
                    </div>
                    <div class="column-header-collapsed hidden flex-col items-center justify-between h-full flex-shrink-0">
                        <div class="vertical-text font-bold text-gray-700">${status.nome_status}</div>
                        <span class="bg-slate-200 text-slate-600 text-sm font-semibold rounded-full w-6 h-6 flex items-center justify-center mb-2">${clientsInStatus.length}</span>
                        <button class="collapse-btn text-gray-400 hover:text-gray-600">
                            <i class="fa-solid fa-angles-left"></i>
                        </button>
                    </div>
                    <div class="kanban-cards min-h-[100px]" data-status-name="${status.nome_status}"></div>
                `;
                
                const cardsContainer = column.querySelector('.kanban-cards');
                clientsInStatus.forEach(client => cardsContainer.appendChild(createClientCard(client)));
                kanbanBoard.appendChild(column);
            });
            
            initializeDragAndDrop();
            initializeColumnControls();
        }

        function formatTimeRemaining(dueDateString) {
            if (!dueDateString) return { text: 'Sem prazo', colorClass: 'text-gray-500', pulse: false };
            const dueDate = new Date(dueDateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(23, 59, 59, 999);
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return { text: 'Atrasado', colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays === 0) return { text: 'Hoje', colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays <= 3) return { text: `Faltam ${diffDays} dias`, colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays <= 7) return { text: `Faltam ${diffDays} dias`, colorClass: 'text-yellow-600 font-semibold', pulse: false };
            return { text: `Faltam ${diffDays} dias`, colorClass: 'text-gray-500', pulse: false };
        }

        function createClientCard(client) {
            const card = document.createElement('div');
            card.className = 'kanban-card bg-white rounded-lg p-4 mb-3 border border-gray-200 hover:border-green-400 hover:shadow-md cursor-pointer transition-all';
            card.dataset.clientId = client.id_cliente;

            const clientTags = (appData.client_tags || [])
                .filter(ct => ct.id_cliente.toString() === client.id_cliente.toString())
                .map(ct => (appData.tags || []).find(t => t.id_tag === ct.id_tag))
                .filter(Boolean);
            
            const tagsHtml = clientTags.map(tag => 
                `<span class="text-xs font-medium mr-1 mb-1 px-2 py-0.5 rounded-full" style="background-color:${tag.cor}20; color:${tag.cor};">${tag.nome_tag}</span>`
            ).join('');
            
            const progress = calculateProgress(client.id_cliente);

            const clientTasks = appData.tasks ? appData.tasks.filter(t => t.id_cliente === client.id_cliente && !t.concluido && t.prazo_final) : [];
            clientTasks.sort((a, b) => new Date(a.prazo_final) - new Date(b.prazo_final));
            const nextTask = clientTasks[0];

            let nextTaskHtml;
            
            if (nextTask) {
                const timeInfo = formatTimeRemaining(nextTask.prazo_final);
                nextTaskHtml = `
                    <div class="mt-3 pt-3 border-t border-gray-100 group relative cursor-pointer" data-task-id="${nextTask.id_tarefa}">
                        <div class="absolute inset-0 bg-green-100 opacity-0 group-hover:opacity-100 transition-opacity rounded-md hidden md:flex items-center justify-center">
                            <span class="text-green-700 font-bold"><i class="fas fa-check mr-2"></i>Marcar como concluída?</span>
                        </div>
                        <p class="text-xs text-gray-400 font-semibold uppercase">Próxima Tarefa</p>
                        <div class="flex items-center justify-between mt-2">
                            <div class="break-words w-full pr-2">
                                <span class="text-sm text-gray-700 font-medium">${nextTask.titulo_tarefa}</span>
                                <p class="text-sm mt-1 ${timeInfo.colorClass} ${timeInfo.pulse ? 'pulse-animation' : ''}">${timeInfo.text}</p>
                            </div>
                            <div class="user-avatar-placeholder w-8 h-8 flex-shrink-0"></div>
                        </div>
                    </div>
                `;
            } else {
                nextTaskHtml = `<div class="text-sm text-gray-400 mt-3 pt-3 border-t border-gray-100">Nenhuma tarefa pendente com prazo.</div>`;
            }

            card.innerHTML = `
                <h3 class="font-semibold text-gray-800 truncate">${client.nome_empresa}</h3>
                <p class="text-sm text-gray-500 mb-3"><i class="fas fa-user mr-2 text-gray-400"></i>${client.nome_responsavel}</p>
                <div class="flex flex-wrap gap-y-1 mb-3">${tagsHtml}</div>
                <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${progress}%"></div></div>
                ${nextTaskHtml}
            `;

            card.addEventListener('click', () => showClientModal(client.id_cliente));
            return card;
        }

        function calculateProgress(clientId) {
            const tasks = appData.tasks ? appData.tasks.filter(p => p.id_cliente === clientId) : [];
            if (tasks.length === 0) return 0;
            const completedTasks = tasks.filter(p => p.concluido).length;
            return Math.round((completedTasks / tasks.length) * 100);
        }

        function initializeDragAndDrop() {
            document.querySelectorAll('.kanban-cards').forEach(container => {
                new Sortable(container, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'opacity-50',
                    onEnd: async (evt) => {
                        const clientId = evt.item.dataset.clientId;
                        const newStatus = evt.to.dataset.statusName;
                        
                        try {
                            const { error } = await dbClient
                                .from('clientes')
                                .update({ status: newStatus })
                                .eq('id_cliente', clientId);

                            if (error) throw error;

                            // Atualizar dados locais
                            const client = appData.clients.find(c => c.id_cliente.toString() === clientId);
                            if (client) {
                                client.status = newStatus;
                            }

                            showToast('Status atualizado com sucesso!');
                        } catch (error) {
                            showToast('Erro ao atualizar status: ' + error.message);
                            // Reverter a mudança visual
                            applyFiltersAndRender();
                        }
                    }
                });
            });
        }

        function initializeColumnControls() {
            document.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const column = btn.closest('.kanban-column');
                    column.classList.toggle('collapsed');
                });
            });
        }

        // --- FUNÇÕES DE AÇÃO DA VISUALIZAÇÃO EM LINHA ---
        async function handleQuickComplete(itemType, itemId) {
            try {
                const tableName = itemType === 'task' ? 'tarefas' : 'tickets';
                const idField = itemType === 'task' ? 'id_tarefa' : 'id_ticket';
                
                const { error } = await dbClient
                    .from(tableName)
                    .update({ concluido: true })
                    .eq(idField, itemId);

                if (error) throw error;

                // Atualizar dados locais
                const dataArray = itemType === 'task' ? appData.tasks : appData.tickets;
                const item = dataArray.find(i => i[idField] === itemId);
                if (item) {
                    item.concluido = true;
                }

                showToast(`${itemType === 'task' ? 'Tarefa' : 'Ticket'} concluída!`);
                renderListView();
            } catch (error) {
                showToast(`Erro ao concluir ${itemType === 'task' ? 'tarefa' : 'ticket'}: ${error.message}`);
            }
        }

        async function openItemEditorModal(itemType, itemId) {
            const item = itemType === 'task' 
                ? appData.tasks.find(t => t.id_tarefa === itemId)
                : appData.tickets.find(t => t.id_ticket === itemId);

            if (!item) {
                showToast('Item não encontrado');
                return;
            }

            const modal = document.getElementById('item-editor-modal');
            const content = document.getElementById('item-editor-content');
            
            const userOptions = appData.users.map(user => 
                `<option value="${user.id_usuario}" ${item.responsavel_id === user.id_usuario ? 'selected' : ''}>${user.nome_usuario}</option>`
            ).join('');
            
            const dueDateValue = item.prazo_final ? new Date(item.prazo_final).toISOString().split('T')[0] : '';
            const titleLabel = itemType === 'task' ? 'Tarefa' : 'Ticket';
            const titleValue = itemType === 'task' ? item.titulo_tarefa : item.titulo_ticket;

            content.innerHTML = `
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">Editar ${titleLabel}</h3>
                    <button onclick="closeItemEditorModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto flex-grow" data-item-id="${itemId}" data-item-type="${itemType}">
                    <input type="text" id="item-editor-title" value="${titleValue}" class="form-input w-full mb-4 text-lg font-semibold" placeholder="Título">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700">Responsável</label>
                            <select id="item-editor-responsible" class="form-input">
                                <option value="">Ninguém</option>
                                ${userOptions}
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">Prazo Final</label>
                            <input type="date" id="item-editor-due-date" value="${dueDateValue}" class="form-input">
                            <div class="flex space-x-2 mt-2">
                                <button type="button" class="suggestion-btn" onclick="addDaysToItemDate(3)">+3 dias</button>
                                <button type="button" class="suggestion-btn" onclick="addDaysToItemDate(7)">+7 dias</button>
                                <button type="button" class="suggestion-btn" onclick="addDaysToItemDate(15)">+15 dias</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="text-sm font-medium text-gray-700">Descrição</label>
                        <div id="item-editor-description"></div>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button id="save-item-btn" onclick="saveItemFromEditor()" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white font-bold py-2 px-4 rounded-full">
                            <i class="fas fa-save mr-2"></i>Salvar Alterações
                        </button>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                content.classList.remove('scale-95', 'opacity-0');
            });

            // Inicializar Quill editor
            itemQuillEditor = new Quill('#item-editor-description', { theme: 'snow' });
            if (item.descricao_detalhada) {
                itemQuillEditor.root.innerHTML = item.descricao_detalhada;
            }
        }

        function addDaysToItemDate(days) {
            const dateInput = document.getElementById('item-editor-due-date');
            const newDate = new Date();
            newDate.setDate(newDate.getDate() + days);
            dateInput.value = newDate.toISOString().split('T')[0];
        }

        function closeItemEditorModal() {
            const modal = document.getElementById('item-editor-modal');
            const content = document.getElementById('item-editor-content');
            
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        async function saveItemFromEditor() {
            const content = document.getElementById('item-editor-content').querySelector('[data-item-id]');
            const itemId = content.dataset.itemId;
            const itemType = content.dataset.itemType;
            
            const title = document.getElementById('item-editor-title').value.trim();
            const responsibleId = document.getElementById('item-editor-responsible').value || null;
            const dueDate = document.getElementById('item-editor-due-date').value || null;
            const description = itemQuillEditor ? itemQuillEditor.root.innerHTML : '';

            if (!title) {
                showToast('Título é obrigatório');
                return;
            }

            const saveBtn = document.getElementById('save-item-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';

            try {
                const tableName = itemType === 'task' ? 'tarefas' : 'tickets';
                const idField = itemType === 'task' ? 'id_tarefa' : 'id_ticket';
                const titleField = itemType === 'task' ? 'titulo_tarefa' : 'titulo_ticket';
                
                const updateData = {
                    [titleField]: title,
                    descricao_detalhada: description,
                    responsavel_id: responsibleId,
                    prazo_final: dueDate
                };

                const { error } = await dbClient
                    .from(tableName)
                    .update(updateData)
                    .eq(idField, itemId);

                if (error) throw error;

                // Atualizar dados locais
                const dataArray = itemType === 'task' ? appData.tasks : appData.tickets;
                const item = dataArray.find(i => i[idField] === itemId);
                if (item) {
                    Object.assign(item, updateData);
                }

                showToast(`${itemType === 'task' ? 'Tarefa' : 'Ticket'} atualizada com sucesso!`);
                closeItemEditorModal();
                renderListView();
            } catch (error) {
                showToast(`Erro ao salvar: ${error.message}`);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Alterações';
            }
        }

        // --- FUNÇÕES DO MODAL DO CLIENTE ---
        function showClientModal(clientId, onReadyCallback = null) {
            const client = appData.clients.find(c => c.id_cliente === clientId); 
            if (!client) return;

            const uncompletedTasksCount = appData.tasks ? appData.tasks.filter(t => t.id_cliente === clientId && !t.concluido).length : 0;
            const uncompletedTicketsCount = appData.tickets ? appData.tickets.filter(t => t.id_cliente === clientId && !t.concluido).length : 0;
            const tasksBadgeHtml = uncompletedTasksCount > 0 ? `<span class="tab-badge">${uncompletedTasksCount}</span>` : '';
            const ticketsBadgeHtml = uncompletedTicketsCount > 0 ? `<span class="tab-badge">${uncompletedTicketsCount}</span>` : '';
            
            modalContent.innerHTML = ''; 
            modalContent.appendChild(loaderTemplate.content.cloneNode(true));
            clientModal.classList.remove('hidden');  
            
            requestAnimationFrame(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            });

            modalContent.innerHTML = `
                <div class="p-6 border-b flex-shrink-0">
                    <div class="flex justify-between items-start">
                        <div><h2 class="text-3xl font-bold text-gray-800">${client.nome_empresa}</h2></div>
                        <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>
                </div>
                <div class="border-b border-gray-200 flex-shrink-0">
                    <nav id="modal-tabs" class="flex space-x-4 px-6 -mb-px overflow-x-auto">
                        <button data-tab="details" class="tab-button active flex-shrink-0">Detalhes</button>
                        <button data-tab="tasks" class="tab-button flex-shrink-0 flex items-center">Tarefas ${tasksBadgeHtml}</button>
                        <button data-tab="tickets" class="tab-button flex-shrink-0 flex items-center">Tickets ${ticketsBadgeHtml}</button>
                    </nav>
                </div>
                <div class="p-6 overflow-y-auto flex-grow">
                    <div id="tab-content-details" class="tab-content active">
                        <div id="modal-form" data-client-id="${clientId}">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                <div><label class="text-sm font-medium text-gray-700">Nome da Empresa</label><input type="text" id="modal-nome_empresa" value="${client.nome_empresa || ''}" class="form-input"></div>
                                <div><label class="text-sm font-medium text-gray-700">CNPJ</label><input type="text" id="modal-cnpj" value="${client.cnpj || ''}" class="form-input"></div>
                                <div><label class="text-sm font-medium text-gray-700">Nome do Responsável</label><input type="text" id="modal-nome_responsavel" value="${client.nome_responsavel || ''}" class="form-input"></div>
                                <div><label class="text-sm font-medium text-gray-700">WhatsApp</label><input type="text" id="modal-whatsapp" value="${client.whatsapp || ''}" class="form-input"></div>
                                <div><label class="text-sm font-medium text-gray-700">E-mail Financeiro</label><input type="text" id="modal-email_financeiro" value="${client.email_financeiro || ''}" class="form-input"></div>
                                <div><label class="text-sm font-medium text-gray-700">Telefone do Dono</label><input type="text" id="modal-telefone_dono" value="${client.telefone_dono || ''}" class="form-input"></div>
                                <div class="md:col-span-2"><label class="text-sm font-medium text-gray-700">Link do Grupo WhatsApp</label><input type="text" id="modal-link_grupo_whatsapp" value="${client.link_grupo_whatsapp || ''}" class="form-input"></div>
                                <div><label class="text-sm font-medium text-gray-700">Valor do Contrato</label><input type="text" id="modal-valor_contrato" value="${client.valor_contrato || ''}" class="form-input" placeholder="R$ 0,00"></div>
                                <div class="md:col-span-2"><label class="text-sm font-medium text-gray-700">Anotações</label><textarea id="modal-anotacoes" rows="4" class="form-input">${client.anotacoes || ''}</textarea></div>
                            </div>
                            <div class="mt-8 pt-5 border-t flex justify-end items-center gap-3">
                                <span id="save-status" class="text-sm text-green-600"></span>
                                <button id="save-client-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white font-bold py-2 px-4 rounded-full flex items-center"><i class="fas fa-save mr-2"></i>Salvar Alterações</button>
                            </div>
                        </div>
                    </div>
                    <div id="tab-content-tasks" class="tab-content">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-600">Tarefas do Projeto</h4>
                            <button id="add-main-task-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white text-sm font-bold py-1 px-3 rounded-full flex items-center"><i class="fas fa-plus mr-2"></i>Nova Tarefa</button>
                        </div>
                        <div id="task-list-container" class="bg-slate-50 p-4 rounded-lg"></div>
                        <div id="task-editor-container" class="mt-4 border-t pt-4 hidden"></div>
                    </div>
                    <div id="tab-content-tickets" class="tab-content">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-600">Tickets/Chamados</h4>
                            <button id="add-main-ticket-btn" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white text-sm font-bold py-1 px-3 rounded-full flex items-center"><i class="fas fa-plus mr-2"></i>Novo Ticket</button>
                        </div>
                        <div id="ticket-list-container" class="bg-slate-50 p-4 rounded-lg"></div>
                        <div id="ticket-editor-container" class="mt-4 border-t pt-4 hidden"></div>
                    </div>
                </div>`;
            
            const tabs = document.querySelectorAll('.tab-button'); 
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => { 
                tab.addEventListener('click', () => { 
                    tabs.forEach(t => t.classList.remove('active')); 
                    contents.forEach(c => c.classList.remove('active')); 
                    tab.classList.add('active'); 
                    document.getElementById(`tab-content-${tab.dataset.tab}`).classList.add('active'); 
                }); 
            });

            renderTaskList(clientId); 
            renderTicketList(clientId);

            document.getElementById('close-modal-btn').addEventListener('click', hideClientModal);
            document.getElementById('save-client-btn').addEventListener('click', () => handleSaveClient(clientId));
            document.getElementById('add-main-task-btn').addEventListener('click', () => showNewTaskForm(clientId));
            document.getElementById('add-main-ticket-btn').addEventListener('click', () => showNewTicketForm(clientId));
            
            if (onReadyCallback) {
                requestAnimationFrame(onReadyCallback);
            }
        }

        function hideClientModal() {
            const form = modalContent.querySelector('#modal-form');
            if (form) {
                const clientId = form.dataset.clientId;
                const client = appData.clients.find(c => c.id_cliente.toString() === clientId);
                if (client) {
                    updateCardOnBoard(client.id_cliente);
                }
            }
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                clientModal.classList.add('hidden');
                if (currentView === 'list') {
                    renderListView();
                }
            }, 300);
        }
        
        function updateCardOnBoard(clientId) {
            const cardElement = document.querySelector(`.kanban-card[data-client-id="${clientId}"]`);
            if (cardElement) {
                const client = appData.clients.find(c => c.id_cliente === clientId);
                if (client) {
                    const newCard = createClientCard(client);
                    cardElement.replaceWith(newCard);
                }
            }
        }

        async function handleSaveClient(clientId) {
            const saveBtn = document.getElementById('save-client-btn');
            const saveStatus = document.getElementById('save-status');
            saveBtn.disabled = true;
            saveStatus.textContent = 'Salvando...';

            const fieldsToUpdate = ['nome_empresa', 'cnpj', 'nome_responsavel', 'whatsapp', 'email_financeiro', 'telefone_dono', 'link_grupo_whatsapp', 'valor_contrato', 'anotacoes'];
            const updatedData = {};
            
            fieldsToUpdate.forEach(field => { 
                const value = document.getElementById(`modal-${field}`).value; 
                updatedData[field] = value; 
            });

            try {
                const { error } = await dbClient
                    .from('clientes')
                    .update(updatedData)
                    .eq('id_cliente', clientId);

                if (error) throw error;

                const clientInState = appData.clients.find(c => c.id_cliente === clientId); 
                if (clientInState) { 
                    Object.assign(clientInState, updatedData); 
                }

                saveStatus.textContent = 'Salvo com sucesso!';
                setTimeout(() => hideClientModal(), 1000);
            } catch (error) {
                saveStatus.textContent = 'Erro ao salvar!';
                setTimeout(() => saveStatus.textContent = '', 2000);
            } finally {
                saveBtn.disabled = false;
            }
        }

        // --- LÓGICA DE TAREFAS ---
        function renderTaskList(clientId) {
            const container = document.getElementById('task-list-container'); 
            const clientTasks = appData.tasks ? appData.tasks.filter(t => t.id_cliente === clientId) : [];
            
            if (clientTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhuma tarefa criada para este cliente.</p>';
                return;
            }

            const tasksHtml = clientTasks.map(task => {
                const responsibleUser = appData.users.find(u => u.id_usuario === task.responsavel_id); 
                const dueDate = task.prazo_final ? new Date(task.prazo_final) : null; 
                const today = new Date(); 
                today.setHours(0,0,0,0); 
                const isOverdue = dueDate && dueDate < today;

                return `
                    <div class="task-item group flex items-center justify-between p-2 hover:bg-gray-100 rounded-md">
                        <div class="flex items-center flex-grow min-w-0">
                            <input type="checkbox" data-task-id="${task.id_tarefa}" class="task-checkbox h-4 w-4 mr-3 flex-shrink-0" ${task.concluido ? 'checked' : ''}>
                            <div class="truncate">
                                <span class="task-title ${task.concluido ? 'line-through text-gray-400' : ''}">${task.titulo_tarefa}</span>
                                ${dueDate ? `<span class="ml-2 text-xs ${isOverdue ? 'text-red-500' : 'text-gray-500'}"><i class="far fa-calendar-alt mr-1"></i>${dueDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</span>` : ''}
                            </div>
                            ${responsibleUser ? `<span class="ml-2 text-xs text-gray-500 bg-gray-200 rounded-full px-2 py-0.5 flex-shrink-0">${responsibleUser.nome_usuario}</span>` : ''}
                        </div>
                        <div class="task-controls opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                            <button title="Editar Tarefa" class="edit-task-btn text-gray-400 hover:text-blue-500 p-1" data-task-id="${task.id_tarefa}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button title="Apagar Tarefa" class="delete-task-btn text-gray-400 hover:text-red-500 p-1" data-task-id="${task.id_tarefa}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = tasksHtml;
            
            container.querySelectorAll('.task-checkbox').forEach(cb => cb.addEventListener('change', async (e) => {
                const taskId = e.target.dataset.taskId;
                const isCompleted = e.target.checked;
                await handleToggleTask(taskId, isCompleted);
            }));
            
            container.querySelectorAll('.edit-task-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const taskId = e.currentTarget.dataset.taskId;
                showTaskEditor(taskId);
            }));
            
            container.querySelectorAll('.delete-task-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const taskId = e.currentTarget.dataset.taskId;
                await handleDeleteTask(taskId);
            }));
        }

        function showTaskEditor(taskId) {
            const editorContainer = document.getElementById('task-editor-container'); 
            const task = appData.tasks.find(t => t.id_tarefa === taskId); 
            if (!task) return;
            
            const userOptions = appData.users.map(user => `<option value="${user.id_usuario}" ${task.responsavel_id === user.id_usuario ? 'selected' : ''}>${user.nome_usuario}</option>`).join('');
            const dueDateValue = task.prazo_final ? new Date(task.prazo_final).toISOString().split('T')[0] : '';
            
            editorContainer.innerHTML = `
                <h5 class="font-bold text-lg mb-2">Editando Tarefa</h5>
                <input type="text" id="editor-task-title" value="${task.titulo_tarefa}" class="form-input w-full mb-2 text-lg font-semibold" placeholder="Título da Tarefa">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Responsável</label>
                        <select id="editor-task-responsible" class="form-input">
                            <option value="">Ninguém</option>
                            ${userOptions}
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Prazo Final</label>
                        <input type="date" id="editor-task-due-date" value="${dueDateValue}" class="form-input">
                        <div class="flex space-x-2 mt-2">
                            <button class="suggestion-btn" onclick="addDaysToTaskDate(3)">+3 dias</button>
                            <button class="suggestion-btn" onclick="addDaysToTaskDate(7)">+7 dias</button>
                            <button class="suggestion-btn" onclick="addDaysToTaskDate(15)">+15 dias</button>
                        </div>
                    </div>
                </div>
                <div class="mt-4" id="quill-editor-task"></div>
                <div class="flex justify-end mt-2">
                    <button onclick="handleSaveTask('${taskId}')" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white font-bold py-2 px-4 rounded-full">Salvar Tarefa</button>
                </div>
            `;
            
            editorContainer.classList.remove('hidden'); 
            quillEditor = new Quill('#quill-editor-task', { theme: 'snow' }); 
            if (task.descricao_detalhada) quillEditor.root.innerHTML = task.descricao_detalhada;
        }

        function addDaysToTaskDate(days) {
            const dateInput = document.getElementById('editor-task-due-date');
            const newDate = new Date();
            newDate.setDate(newDate.getDate() + days);
            dateInput.value = newDate.toISOString().split('T')[0];
        }

        async function handleSaveTask(taskId) {
            const title = document.getElementById('editor-task-title').value; 
            const description = quillEditor.root.innerHTML; 
            const responsibleId = document.getElementById('editor-task-responsible').value || null; 
            const dueDate = document.getElementById('editor-task-due-date').value || null;
            
            try {
                const { error } = await dbClient
                    .from('tarefas')
                    .update({
                        titulo_tarefa: title,
                        descricao_detalhada: description,
                        responsavel_id: responsibleId,
                        prazo_final: dueDate
                    })
                    .eq('id_tarefa', taskId);

                if (error) throw error;

                // Atualizar dados locais
                const task = appData.tasks.find(t => t.id_tarefa === taskId);
                if (task) {
                    task.titulo_tarefa = title;
                    task.descricao_detalhada = description;
                    task.responsavel_id = responsibleId;
                    task.prazo_final = dueDate;
                }

                const client = appData.clients.find(c => c.id_cliente === task.id_cliente);
                showClientModal(client.id_cliente); 
                setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50);
                showToast('Tarefa salva com sucesso!');
            } catch (error) {
                showToast('Erro ao salvar a tarefa: ' + error.message);
            }
        }

        function showNewTaskForm(clientId) {
            const container = document.getElementById('task-list-container');
            
            if (document.getElementById('new-task-form')) return;

            const formHtml = `
                <div id="new-task-form" class="task-form-container">
                    <input type="text" id="new-task-title" class="task-title-input" placeholder="Digite o título da tarefa e pressione Enter">
                    <div id="task-form-expanded" class="hidden mt-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Responsável</label>
                                <select id="new-task-responsible" class="form-input">
                                    <option value="">Selecione um responsável</option>
                                    ${appData.users.map(user => `<option value="${user.id_usuario}">${user.nome_usuario}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Prazo Final</label>
                                <input type="date" id="new-task-due-date" class="form-input">
                                <div class="flex space-x-2 mt-2">
                                    <button type="button" class="suggestion-btn" onclick="addDaysToNewTaskDate(3)">+3 dias</button>
                                    <button type="button" class="suggestion-btn" onclick="addDaysToNewTaskDate(7)">+7 dias</button>
                                    <button type="button" class="suggestion-btn" onclick="addDaysToNewTaskDate(15)">+15 dias</button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700">Descrição</label>
                            <div id="quill-editor-new-task"></div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="cancelNewTask()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300">Cancelar</button>
                            <button type="button" onclick="saveNewTask('${clientId}')" class="px-4 py-2 text-white bg-[#2fc36a] rounded-full hover:bg-[#29a85b]">Salvar Tarefa</button>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('afterbegin', formHtml);
            
            const titleInput = document.getElementById('new-task-title');
            const expandedForm = document.getElementById('task-form-expanded');
            const formContainer = document.getElementById('new-task-form');
            
            titleInput.focus();
            
            titleInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && titleInput.value.trim()) {
                    expandedForm.classList.remove('hidden');
                    formContainer.classList.add('task-form-expanded');
                    
                    // Inicializar Quill editor
                    window.newTaskQuillEditor = new Quill('#quill-editor-new-task', { theme: 'snow' });
                }
            });
        }

        function addDaysToNewTaskDate(days) {
            const dateInput = document.getElementById('new-task-due-date');
            const newDate = new Date();
            newDate.setDate(newDate.getDate() + days);
            dateInput.value = newDate.toISOString().split('T')[0];
        }

        function cancelNewTask() {
            const form = document.getElementById('new-task-form');
            if (form) form.remove();
        }

        async function saveNewTask(clientId) {
            const title = document.getElementById('new-task-title').value.trim();
            const responsibleId = document.getElementById('new-task-responsible').value || null;
            const dueDate = document.getElementById('new-task-due-date').value || null;
            const description = window.newTaskQuillEditor ? window.newTaskQuillEditor.root.innerHTML : '';

            if (!title) {
                showToast('Título da tarefa é obrigatório');
                return;
            }

            try {
                // Gerar ID único
                const uniqueId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                
                const { data, error } = await dbClient
                    .from('tarefas')
                    .insert({
                        id_tarefa: uniqueId,
                        id_cliente: clientId,
                        titulo_tarefa: title,
                        descricao_detalhada: description,
                        responsavel_id: responsibleId,
                        prazo_final: dueDate,
                        concluido: false,
                        ordem: 1
                    })
                    .select()
                    .single();

                if (error) throw error;

                // Adicionar aos dados locais
                appData.tasks.push(data);
                
                showToast('Tarefa criada com sucesso!');
                showClientModal(clientId);
                setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50);
            } catch (error) {
                showToast('Erro ao criar tarefa: ' + error.message);
            }
        }

        async function handleToggleTask(taskId, isCompleted) {
            try {
                const { error } = await dbClient
                    .from('tarefas')
                    .update({ concluido: isCompleted })
                    .eq('id_tarefa', taskId);

                if (error) throw error;

                // Atualizar dados locais
                const task = appData.tasks.find(t => t.id_tarefa === taskId);
                if (task) {
                    task.concluido = isCompleted;
                }

                showClientModal(task.id_cliente);
                setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50);
                showToast(isCompleted ? 'Tarefa concluída!' : 'Tarefa reaberta!');
            } catch (error) {
                showToast('Erro ao atualizar tarefa: ' + error.message);
            }
        }

        async function handleDeleteTask(taskId) {
            showConfirmationModal("Tem certeza que deseja excluir esta tarefa?", async () => {
                try {
                    const { error } = await dbClient
                        .from('tarefas')
                        .delete()
                        .eq('id_tarefa', taskId);

                    if (error) throw error;

                    // Remover dos dados locais
                    const taskIndex = appData.tasks.findIndex(t => t.id_tarefa === taskId);
                    const task = appData.tasks[taskIndex];
                    if (taskIndex > -1) {
                        appData.tasks.splice(taskIndex, 1);
                    }

                    showClientModal(task.id_cliente);
                    setTimeout(() => document.querySelector('button[data-tab="tasks"]').click(), 50);
                    showToast('Tarefa excluída!');
                } catch (error) {
                    showToast('Erro ao excluir tarefa: ' + error.message);
                }
            });
        }

        // --- LÓGICA DE TICKETS ---
        function renderTicketList(clientId) {
            const container = document.getElementById('ticket-list-container'); 
            const clientTickets = appData.tickets ? appData.tickets.filter(t => t.id_cliente === clientId) : [];
            
            if (clientTickets.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhum ticket criado para este cliente.</p>';
                return;
            }

            const ticketsHtml = clientTickets.map(ticket => {
                const responsibleUser = appData.users.find(u => u.id_usuario === ticket.responsavel_id); 
                const dueDate = ticket.prazo_final ? new Date(ticket.prazo_final) : null; 
                const today = new Date(); 
                today.setHours(0,0,0,0); 
                const isOverdue = dueDate && dueDate < today && !ticket.concluido;

                return `
                    <div class="task-item group flex items-center justify-between p-2 hover:bg-gray-100 rounded-md">
                        <div class="flex items-center flex-grow min-w-0">
                            <input type="checkbox" data-ticket-id="${ticket.id_ticket}" class="ticket-checkbox h-4 w-4 mr-3 flex-shrink-0" ${ticket.concluido ? 'checked' : ''}>
                            <div class="truncate">
                                <span class="ticket-title ${ticket.concluido ? 'line-through text-gray-400' : ''}">${ticket.titulo_ticket}</span>
                                ${dueDate ? `<span class="ml-2 text-xs ${isOverdue ? 'text-red-500 font-semibold' : 'text-gray-500'}"><i class="far fa-calendar-alt mr-1"></i>${dueDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' })}</span>` : ''}
                            </div>
                            ${responsibleUser ? `<span class="ml-2 text-xs text-gray-500 bg-gray-200 rounded-full px-2 py-0.5 flex-shrink-0">${responsibleUser.nome_usuario}</span>` : ''}
                        </div>
                        <div class="task-controls opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                            <button title="Editar Ticket" class="edit-ticket-btn text-gray-400 hover:text-blue-500 p-1" data-ticket-id="${ticket.id_ticket}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button title="Apagar Ticket" class="delete-ticket-btn text-gray-400 hover:text-red-500 p-1" data-ticket-id="${ticket.id_ticket}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = ticketsHtml;
            
            container.querySelectorAll('.ticket-checkbox').forEach(cb => cb.addEventListener('change', async (e) => {
                const ticketId = e.target.dataset.ticketId;
                const isCompleted = e.target.checked;
                await handleToggleTicket(ticketId, isCompleted);
            }));
            
            container.querySelectorAll('.edit-ticket-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const ticketId = e.currentTarget.dataset.ticketId;
                showTicketEditor(ticketId);
            }));
            
            container.querySelectorAll('.delete-ticket-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const ticketId = e.currentTarget.dataset.ticketId;
                await handleDeleteTicket(ticketId);
            }));
        }

        function showTicketEditor(ticketId) {
            const editorContainer = document.getElementById('ticket-editor-container'); 
            const ticket = appData.tickets.find(t => t.id_ticket === ticketId); 
            if (!ticket) return;
            
            const userOptions = appData.users.map(user => `<option value="${user.id_usuario}" ${ticket.responsavel_id === user.id_usuario ? 'selected' : ''}>${user.nome_usuario}</option>`).join('');
            const dueDateValue = ticket.prazo_final ? new Date(ticket.prazo_final).toISOString().split('T')[0] : '';
            
            editorContainer.innerHTML = `
                <h5 class="font-bold text-lg mb-2">Editando Ticket</h5>
                <input type="text" id="editor-ticket-title" value="${ticket.titulo_ticket}" class="form-input w-full mb-2 text-lg font-semibold" placeholder="Título do Ticket">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Responsável</label>
                        <select id="editor-ticket-responsible" class="form-input">
                            <option value="">Ninguém</option>
                            ${userOptions}
                        </select>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Prazo Final</label>
                        <input type="date" id="editor-ticket-due-date" value="${dueDateValue}" class="form-input">
                        <div class="flex space-x-2 mt-2">
                            <button class="suggestion-btn" onclick="addDaysToTicketDate(3)">+3 dias</button>
                            <button class="suggestion-btn" onclick="addDaysToTicketDate(7)">+7 dias</button>
                            <button class="suggestion-btn" onclick="addDaysToTicketDate(15)">+15 dias</button>
                        </div>
                    </div>
                </div>
                <div class="mt-4" id="quill-editor-ticket"></div>
                <div class="flex justify-end mt-2">
                    <button onclick="handleSaveTicket('${ticketId}')" class="bg-[#2fc36a] hover:bg-[#29a85b] text-white font-bold py-2 px-4 rounded-full">Salvar Ticket</button>
                </div>
            `;
            
            editorContainer.classList.remove('hidden'); 
            quillEditor = new Quill('#quill-editor-ticket', { theme: 'snow' }); 
            if (ticket.descricao_detalhada) quillEditor.root.innerHTML = ticket.descricao_detalhada;
        }

        function addDaysToTicketDate(days) {
            const dateInput = document.getElementById('editor-ticket-due-date');
            const newDate = new Date();
            newDate.setDate(newDate.getDate() + days);
            dateInput.value = newDate.toISOString().split('T')[0];
        }

        async function handleSaveTicket(ticketId) {
            const title = document.getElementById('editor-ticket-title').value; 
            const description = quillEditor.root.innerHTML; 
            const responsibleId = document.getElementById('editor-ticket-responsible').value || null; 
            const dueDate = document.getElementById('editor-ticket-due-date').value || null;
            
            try {
                const { error } = await dbClient
                    .from('tickets')
                    .update({
                        titulo_ticket: title,
                        descricao_detalhada: description,
                        responsavel_id: responsibleId,
                        prazo_final: dueDate
                    })
                    .eq('id_ticket', ticketId);

                if (error) throw error;

                // Atualizar dados locais
                const ticket = appData.tickets.find(t => t.id_ticket === ticketId);
                if (ticket) {
                    ticket.titulo_ticket = title;
                    ticket.descricao_detalhada = description;
                    ticket.responsavel_id = responsibleId;
                    ticket.prazo_final = dueDate;
                }

                const client = appData.clients.find(c => c.id_cliente === ticket.id_cliente);
                showClientModal(client.id_cliente); 
                setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50);
                showToast('Ticket salvo com sucesso!');
            } catch (error) {
                showToast('Erro ao salvar o ticket: ' + error.message);
            }
        }

        function showNewTicketForm(clientId) {
            const container = document.getElementById('ticket-list-container');
            
            if (document.getElementById('new-ticket-form')) return;

            const formHtml = `
                <div id="new-ticket-form" class="task-form-container">
                    <input type="text" id="new-ticket-title" class="task-title-input" placeholder="Digite o título do ticket e pressione Enter">
                    <div id="ticket-form-expanded" class="hidden mt-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">Responsável</label>
                                <select id="new-ticket-responsible" class="form-input">
                                    <option value="">Selecione um responsável</option>
                                    ${appData.users.map(user => `<option value="${user.id_usuario}">${user.nome_usuario}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">Prazo Final</label>
                                <input type="date" id="new-ticket-due-date" class="form-input">
                                <div class="flex space-x-2 mt-2">
                                    <button type="button" class="suggestion-btn" onclick="addDaysToNewTicketDate(3)">+3 dias</button>
                                    <button type="button" class="suggestion-btn" onclick="addDaysToNewTicketDate(7)">+7 dias</button>
                                    <button type="button" class="suggestion-btn" onclick="addDaysToNewTicketDate(15)">+15 dias</button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700">Descrição</label>
                            <div id="quill-editor-new-ticket"></div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="button" onclick="cancelNewTicket()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300">Cancelar</button>
                            <button type="button" onclick="saveNewTicket('${clientId}')" class="px-4 py-2 text-white bg-[#2fc36a] rounded-full hover:bg-[#29a85b]">Salvar Ticket</button>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('afterbegin', formHtml);
            
            const titleInput = document.getElementById('new-ticket-title');
            const expandedForm = document.getElementById('ticket-form-expanded');
            const formContainer = document.getElementById('new-ticket-form');
            
            titleInput.focus();
            
            titleInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && titleInput.value.trim()) {
                    expandedForm.classList.remove('hidden');
                    formContainer.classList.add('task-form-expanded');
                    
                    // Inicializar Quill editor
                    window.newTicketQuillEditor = new Quill('#quill-editor-new-ticket', { theme: 'snow' });
                }
            });
        }

        function addDaysToNewTicketDate(days) {
            const dateInput = document.getElementById('new-ticket-due-date');
            const newDate = new Date();
            newDate.setDate(newDate.getDate() + days);
            dateInput.value = newDate.toISOString().split('T')[0];
        }

        function cancelNewTicket() {
            const form = document.getElementById('new-ticket-form');
            if (form) form.remove();
        }

        async function saveNewTicket(clientId) {
            const title = document.getElementById('new-ticket-title').value.trim();
            const responsibleId = document.getElementById('new-ticket-responsible').value || null;
            const dueDate = document.getElementById('new-ticket-due-date').value || null;
            const description = window.newTicketQuillEditor ? window.newTicketQuillEditor.root.innerHTML : '';

            if (!title) {
                showToast('Título do ticket é obrigatório');
                return;
            }

            try {
                // Gerar ID único
                const uniqueId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                
                const { data, error } = await dbClient
                    .from('tickets')
                    .insert({
                        id_ticket: uniqueId,
                        id_cliente: clientId,
                        titulo_ticket: title,
                        descricao_detalhada: description,
                        responsavel_id: responsibleId,
                        prazo_final: dueDate,
                        concluido: false,
                        ordem: 1
                    })
                    .select()
                    .single();

                if (error) throw error;

                // Adicionar aos dados locais
                appData.tickets.push(data);
                
                showToast('Ticket criado com sucesso!');
                showClientModal(clientId);
                setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50);
            } catch (error) {
                showToast('Erro ao criar ticket: ' + error.message);
            }
        }

        async function handleToggleTicket(ticketId, isCompleted) {
            try {
                const { error } = await dbClient
                    .from('tickets')
                    .update({ concluido: isCompleted })
                    .eq('id_ticket', ticketId);

                if (error) throw error;

                // Atualizar dados locais
                const ticket = appData.tickets.find(t => t.id_ticket === ticketId);
                if (ticket) {
                    ticket.concluido = isCompleted;
                }

                showClientModal(ticket.id_cliente);
                setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50);
                showToast(isCompleted ? 'Ticket concluído!' : 'Ticket reaberto!');
            } catch (error) {
                showToast('Erro ao atualizar ticket: ' + error.message);
            }
        }

        async function handleDeleteTicket(ticketId) {
            showConfirmationModal("Tem certeza que deseja excluir este ticket?", async () => {
                try {
                    const { error } = await dbClient
                        .from('tickets')
                        .delete()
                        .eq('id_ticket', ticketId);

                    if (error) throw error;

                    // Remover dos dados locais
                    const ticketIndex = appData.tickets.findIndex(t => t.id_ticket === ticketId);
                    const ticket = appData.tickets[ticketIndex];
                    if (ticketIndex > -1) {
                        appData.tickets.splice(ticketIndex, 1);
                    }

                    showClientModal(ticket.id_cliente);
                    setTimeout(() => document.querySelector('button[data-tab="tickets"]').click(), 50);
                    showToast('Ticket excluído!');
                } catch (error) {
                    showToast('Erro ao excluir ticket: ' + error.message);
                }
            });
        }

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            searchInput.addEventListener('input', applyFiltersAndRender);
            
            // Verificar se há usuário logado
            const savedUser = localStorage.getItem('crmUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp(true);
            } else {
                loginScreen.classList.remove('hidden');
            }

            // Configurar eventos de teclado
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!document.getElementById('item-editor-modal').classList.contains('hidden')) closeItemEditorModal();
                    else if (!clientModal.classList.contains('hidden')) hideClientModal();
                }
            });
        });

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            const installButtonLogin = document.getElementById('install-pwa-login-button');
            const installButtonHeader = document.getElementById('install-pwa-header-button');
            const showInstallButtons = () => { if (installButtonLogin) installButtonLogin.classList.remove('hidden'); if (installButtonHeader) installButtonHeader.classList.remove('hidden'); };
            const installHandler = () => {
                if (installButtonLogin) installButtonLogin.classList.add('hidden'); if (installButtonHeader) installButtonHeader.classList.add('hidden');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log(choiceResult.outcome === 'accepted' ? 'Usuário instalou o PWA' : 'Usuário recusou a instalação do PWA');
                    deferredPrompt = null;
                });
            };
            showInstallButtons();
            if (installButtonLogin) installButtonLogin.addEventListener('click', installHandler);
            if (installButtonHeader) installButtonHeader.addEventListener('click', installHandler);
        });

    </script>
</body>
</html>

