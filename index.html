<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prisme Sales - CRM (Supabase)</title>
    
    <!-- INÍCIO: Tags para PWA e Ícones Personalizados -->
    <meta name="theme-color" content="#2fc36a">
    
    <!-- Favicons para Navegadores -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.png">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/favicon-16x16.ico">

    <!-- Ícone para "Adicionar à Tela de Início" no iOS -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/nattanlima/meu-crm-pwa/main/icons/apple-touch-icon.png">

    <!-- Manifesto do PWA -->
    <link rel="manifest" id="manifest">
    <!-- FIM: Tags para PWA e Ícones Personalizados -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <!-- INÍCIO: Inclusão do Cliente Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- FIM: Inclusão do Cliente Supabase -->

    <style>
        /* --- ESTILOS GERAIS E MELHORIAS DE LAYOUT --- */
        html, body {
            height: 100%;
            overflow: hidden; /* Impede o scroll da página inteira */
            background-color: #f8fafc; /* slate-50 */
        }
        .kanban-board-container::-webkit-scrollbar { height: 8px; }
        .kanban-board-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .kanban-board-container::-webkit-scrollbar-thumb { background: #a3a3a3; border-radius: 4px; }
        
        /* --- ESTILOS DO QUADRO KANBAN (ESTILO TRELLO) --- */
        #kanban-board {
            height: calc(100vh - 73px); /* Altura do header em desktop */
            overflow-x: auto; /* Garante o scroll horizontal */
            overflow-y: hidden; /* Previne o scroll vertical no quadro */
        }
        @media (max-width: 767px) {
            #kanban-board {
                height: calc(100vh - 125px); /* Altura do header em mobile */
            }
        }
        .kanban-column {
            height: 100%; /* Colunas ocupam toda a altura do board */
            display: flex;
            flex-direction: column;
        }
        .kanban-cards {
            flex-grow: 1; /* Faz a área dos cards ocupar o espaço restante */
            overflow-y: auto; /* Habilita o scroll vertical DENTRO da coluna */
            padding-right: 4px; /* Espaço para a barra de rolagem */
            scrollbar-width: none; /* Firefox */
        }
        .kanban-cards::-webkit-scrollbar { 
            display: none; /* Chrome, Safari, and Opera */
        }

        /* --- ESTILOS DO MODAL --- */
        #task-list-container, #ticket-list-container {
            max-height: 45vh; /* Define uma altura máxima para a lista */
            overflow-y: auto; /* Adiciona scroll apenas na lista quando necessário */
        }
        #task-list-container::-webkit-scrollbar, #ticket-list-container::-webkit-scrollbar { width: 6px; }
        #task-list-container::-webkit-scrollbar-track, #ticket-list-container::-webkit-scrollbar-track { background: #e2e8f0; }
        #task-list-container::-webkit-scrollbar-thumb, #ticket-list-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .tab-badge {
            background-color: #e2e8f0; /* slate-200 */
            color: #475569; /* slate-600 */
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: 8px;
        }

        /* --- ESTILOS DO FILTRO E MENU DE USUÁRIO --- */
        .popup-menu {
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .popup-menu.hidden {
            transform: translateY(-10px);
            opacity: 0;
            pointer-events: none;
        }
        .filter-tag-option {
            transition: background-color: 0.2s;
        }
        .filter-tag-option:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        
        /* UPGRADE: Estilo para a nova visão de lista */
        .list-item-row { transition: background-color 0.2s, border-color 0.2s; }
        .list-item-row:hover {
            background-color: #f8fafc; /* slate-50 */
        }

        /* --- OUTROS ESTILOS --- */
        .kanban-card { user-select: none; }
        .kanban-column.collapsed { width: 56px; cursor: pointer; }
        .kanban-column.collapsed .column-header-expanded, .kanban-column.collapsed .kanban-cards { display: none; }
        .kanban-column.collapsed .column-header-collapsed { display: flex; }
        .kanban-column .column-header-collapsed .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; padding: 16px 0; }
        .form-input { margin-top: 4px; display: block; width: 100%; border-radius: 0.5rem; border: 1px solid #d4d4d8; padding: 0.5rem 0.75rem; background-color: #fafafa; }
        .form-input:focus { border-color: #16a34a; outline: 2px solid transparent; outline-offset: 2px; box-shadow: 0 0 0 2px #a7f3d0; }
        .ql-editor { min-height: 150px; }
        .tab-button { cursor: pointer; padding: 0.5rem 1rem; border-bottom: 2px solid transparent; color: #737373; }
        .tab-button.active { border-color: #2fc36a; color: #15803d; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .suggestion-btn { background-color: #f4f4f5; color: #52525b; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 500; transition: background-color 0.2s; }
        .suggestion-btn:hover { background-color: #e4e4e7; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.02); } }
        .pulse-animation { animation: pulse 2.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="font-sans h-full">

    <!-- Ecrã de Login -->
    <div id="login-screen" class="flex items-center justify-center h-screen bg-slate-100 p-4">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-xl shadow-md">
            <div class="text-center">
                <img src="https://crm.prismeapp.com.br/web/binary/company_logo" alt="Logo Prisme Sales" class="mx-auto h-20 w-auto" onerror="this.style.display='none'">
                <h2 class="mt-6 text-3xl font-bold text-gray-900">Prisme Sales - CRM</h2>
                <p class="text-gray-500">Faça login para continuar</p>
            </div>
            <div id="login-error" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
            <form id="login-form" class="space-y-4">
                <div><label for="email" class="text-sm font-medium text-gray-700">Email</label><input id="email" type="email" required class="form-input" placeholder="seu.email@prismeapp.com.br"></div>
                <div><label for="telefone" class="text-sm font-medium text-gray-700">Sua senha</label><input id="telefone" type="password" required class="form-input" placeholder="••••••••"></div>
                <div><button type="submit" class="w-full px-4 py-2 text-lg font-semibold text-white bg-[#2fc36a] rounded-full hover:bg-[#29a85b] transition-colors">Entrar</button></div>
                <div>
                    <button type="button" id="install-pwa-login-button" class="hidden w-full px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i> Instalar App
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ecrã de Carregamento -->
    <div id="loading-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-100 z-50">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-600 z-10 pulse-animation">Preparando tudo para você relacionar mais!</h2>
    </div>

    <!-- Aplicação Principal -->
    <div id="crm-app" class="hidden h-full flex flex-col">
        <header class="bg-white p-4 flex flex-wrap gap-4 justify-between items-center border-b border-slate-200 flex-shrink-0">
            <!-- Logo e Título -->
            <div class="flex items-center space-x-3">
                <img src="https://crm.prismeapp.com.br/web/binary/company_logo" alt="Logo Prisme Sales" class="h-8 w-auto" onerror="this.style.display='none'">
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">Seu CRM</h1>
            </div>
            
            <!-- Controles Centrais (Pesquisa e Filtro) -->
            <div class="w-full md:w-auto md:flex-1 flex justify-center px-0 md:px-4 order-3 md:order-2">
                <div class="flex items-center gap-2 w-full max-w-lg">
                    <!-- Filtro de Tags -->
                    <div id="filter-container" class="relative flex-shrink-0">
                         <button id="filter-trigger-btn" data-active-tag-id="" class="flex items-center justify-center w-full px-4 py-2 border border-gray-300 rounded-full bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                             <span id="filter-btn-text">TODOS</span>
                             <i class="fas fa-chevron-down ml-2 text-xs text-gray-500"></i>
                         </button>
                         <div id="filter-popup" class="hidden popup-menu absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                             <div id="filter-options-container" class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                 <!-- Opções de filtro serão inseridas aqui -->
                             </div>
                         </div>
                    </div>
                    <!-- Barra de Pesquisa -->
                    <div class="relative flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="search" id="search-input" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full bg-slate-50 focus:bg-white focus:ring-2 focus:ring-green-400 focus:border-green-400" placeholder="Pesquisar por empresa...">
                    </div>
                    <!-- UPGRADE: Botão de alternância de visualização -->
                    <button id="view-toggle-btn" class="flex-shrink-0 flex items-center justify-center w-11 h-11 border border-gray-300 rounded-full bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors" title="Alternar para Visão de Lista">
                        <i id="view-toggle-icon" class="fas fa-list-check text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Controles do Usuário -->
            <div class="flex items-center space-x-4 justify-end order-2 md:order-3">
                <button id="install-pwa-header-button" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2 px-3 rounded-full" title="Instalar App">
                    <i class="fas fa-download"></i>
                </button>
                <!-- Menu de Usuário -->
                <div id="user-menu-container" class="relative">
                    <button id="user-avatar-btn" class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold text-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 overflow-hidden">
                        <!-- User initial or image will be inserted here -->
                    </button>
                    <div id="logout-popup" class="hidden popup-menu absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-20">
                        <div class="py-1">
                            <div class="px-4 py-2 border-b">
                                <p id="popup-user-name" class="text-sm font-semibold text-gray-900 truncate"></p>
                                <p id="popup-user-email" class="text-sm text-gray-500 truncate"></p>
                            </div>
                            <a href="#" id="popup-logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sair</a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="kanban-board" class="kanban-board-container flex space-x-4 p-4 flex-grow"></main>

        <!-- UPGRADE: Nova Visão de Lista -->
        <div id="list-view" class="hidden flex-grow flex flex-col">
            <!-- Filtros da Lista -->
            <div id="list-view-filters" class="p-4 bg-white border-b border-slate-200 flex-shrink-0 flex flex-wrap gap-4 items-center">
                <span class="font-semibold text-gray-700 hidden md:inline">Filtros da Lista:</span>
                <!-- Filtro de Tipo -->
                <div class="relative">
                    <select id="list-filter-type" class="form-input !m-0 !py-1.5 !pl-3 !pr-8 appearance-none bg-slate-50">
                        <option value="all">Todos os Tipos</option>
                        <option value="task">Apenas Tarefas</option>
                        <option value="ticket">Apenas Tickets</option>
                    </select>
                </div>
                <!-- Filtro de Responsável -->
                <div class="relative">
                    <select id="list-filter-responsible" class="form-input !m-0 !py-1.5 !pl-3 !pr-8 appearance-none bg-slate-50">
                        <!-- Opções de usuários serão inseridas aqui -->
                    </select>
                </div>
            </div>
            <!-- Container da Lista de Atividades -->
            <div id="list-view-container" class="overflow-y-auto flex-grow p-4">
                <!-- Itens da lista serão inseridos aqui -->
            </div>
        </div>

    </div>

    <!-- Modal do Cliente -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-20">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg md:max-w-4xl max-h-[90vh] flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0"></div>
    </div>
    
    <!-- NOVO MODAL: Editor de Tarefa/Ticket -->
    <div id="item-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 z-30">
        <div id="item-editor-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <!-- Conteúdo do editor será injetado aqui -->
        </div>
    </div>

    <!-- Modal de Confirmação Genérico -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <p id="confirmation-message" class="text-lg text-gray-800 mb-6">Você tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 rounded-full text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">Cancelar</button>
                <button id="confirm-action-btn" class="px-6 py-2 rounded-full text-white bg-red-500 hover:bg-red-600 font-semibold">Confirmar</button>
            </div>
        </div>
    </div>
    
    <template id="loader-template"><div class="flex items-center justify-center h-full p-8"><i class="fas fa-spinner fa-spin text-4xl text-green-500"></i></div></template>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300 z-40"></div>

    <script>
        // --- INÍCIO: CONFIGURAÇÃO DO SUPABASE ---
        const SUPABASE_URL = 'https://ccenxfyqwtfpexltuwrn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZW54Znlxd3RmcGV4bHR1d3JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzE1MTMsImV4cCI6MjA2ODg0NzUxM30.6un31sODuCyd5Dz_pR_kn656k74jjh5CNAfF0YteT7I';
        
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // --- FIM: CONFIGURAÇÃO DO SUPABASE ---

        // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
        const CARDS_TO_SHOW_INITIAL = 30;
        const CARDS_TO_LOAD_MORE = 15;

        const loginScreen = document.getElementById('login-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const crmApp = document.getElementById('crm-app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const kanbanBoard = document.getElementById('kanban-board');
        const clientModal = document.getElementById('client-modal');
        const modalContent = document.getElementById('modal-content');
        const searchInput = document.getElementById('search-input');
        const loaderTemplate = document.getElementById('loader-template');
        const toast = document.getElementById('toast');
        
        // O objeto appData agora será a nossa fonte da verdade, populado pelo Supabase
        let appData = {
            clients: [],
            statuses: [],
            users: [],
            tags: [],
            client_tags: [], // Nome da tabela no Supabase
            tasks: [],
            tickets: []
        };
        
        let quillEditor = null; // Editor principal no modal do cliente
        let itemQuillEditor = null; // Editor secundário no novo modal de item
        let currentUser = null;
        let deferredPrompt;
        let activeTagId = null;

        // UPGRADE: Variáveis de estado para a nova visão
        let currentView = 'kanban'; // 'kanban' ou 'list'
        let listFilterType = 'all';
        let listFilterResponsibleId = 'all';
        const listView = document.getElementById('list-view');
        const viewToggleButton = document.getElementById('view-toggle-btn');
        const viewToggleIcon = document.getElementById('view-toggle-icon');

        // --- FUNÇÕES DE UTILIDADE ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }

        // --- LÓGICA DE CONFIRMAÇÃO ---
        function showConfirmationModal(message, onConfirm) {
            const confirmationModal = document.getElementById('confirmation-modal');
            const messageEl = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirm-action-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            messageEl.textContent = message;

            const confirmHandler = () => {
                onConfirm();
                hideConfirmationModal();
            };

            const cancelHandler = () => {
                hideConfirmationModal();
            };
            
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));

            document.getElementById('confirm-action-btn').addEventListener('click', confirmHandler);
            document.getElementById('confirm-cancel-btn').addEventListener('click', cancelHandler);

            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }


        // --- LÓGICA DE AUTENTICAÇÃO E INICIALIZAÇÃO ---
        function showApp(isInitialLoad = false) {
            if (isInitialLoad) {
                loginScreen.classList.add('hidden');
                loadingScreen.classList.remove('hidden');
            }
            
            const userAvatarBtn = document.getElementById('user-avatar-btn');
            userAvatarBtn.innerHTML = '';
            // Os nomes das colunas foram atualizados para corresponder ao esquema do Supabase
            const userInitial = currentUser.nome_usuario ? currentUser.nome_usuario.charAt(0).toUpperCase() : '?';
            
            const fallback = document.createElement('span');
            fallback.className = 'text-lg';
            fallback.textContent = userInitial;

            if (currentUser.foto_url) {
                const img = document.createElement('img');
                img.src = currentUser.foto_url;
                img.crossOrigin = "anonymous";
                img.referrerPolicy = "no-referrer";
                img.className = 'w-full h-full rounded-full object-cover';
                img.alt = 'Avatar';
                img.onerror = () => {
                    userAvatarBtn.innerHTML = '';
                    userAvatarBtn.appendChild(fallback);
                };
                userAvatarBtn.appendChild(img);
            } else {
                userAvatarBtn.appendChild(fallback);
            }
            
            document.getElementById('popup-user-name').textContent = currentUser.nome_usuario;
            document.getElementById('popup-user-email').textContent = currentUser.email;
            
            initializeApp();
        }

        function showLogin() {
            localStorage.removeItem('crmUser');
            currentUser = null;
            crmApp.classList.add('hidden');
            loadingScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const telefone = document.getElementById('telefone').value;
            loginError.classList.add('hidden');

            try {
                // Lógica de login agora usa o cliente Supabase
                const { data, error } = await dbClient
                    .from('USUARIOS')
                    .select('*')
                    .eq('email', email)
                    .eq('telefone', telefone)
                    .single(); // .single() espera um único resultado ou lança um erro

                if (error) {
                    throw new Error('Credenciais inválidas ou usuário não encontrado.');
                }

                if (data) {
                    currentUser = data;
                    localStorage.setItem('crmUser', JSON.stringify(currentUser));
                    showApp(true);
                } else {
                     throw new Error('Credenciais inválidas.');
                }
            } catch (err) {
                loginError.textContent = err.message;
                loginError.classList.remove('hidden');
            }
        });

        async function initializeApp() {
            try {
                // 1. Buscar todos os dados iniciais do Supabase
                const [
                    clientsRes, statusesRes, usersRes, tagsRes, 
                    clientTagsRes, tasksRes, ticketsRes
                ] = await Promise.all([
                    dbClient.from('CLIENTES').select('*'),
                    dbClient.from('STATUS').select('*'),
                    dbClient.from('USUARIOS').select('*'),
                    dbClient.from('TAGS').select('*'),
                    dbClient.from('CLIENTE_TAGS').select('*'),
                    dbClient.from('TAREFAS').select('*'),
                    dbClient.from('TICKETS').select('*')
                ]);

                // Verificação de erros para cada requisição
                if (clientsRes.error) throw clientsRes.error;
                if (statusesRes.error) throw statusesRes.error;
                if (usersRes.error) throw usersRes.error;
                if (tagsRes.error) throw tagsRes.error;
                if (clientTagsRes.error) throw clientTagsRes.error;
                if (tasksRes.error) throw tasksRes.error;
                if (ticketsRes.error) throw ticketsRes.error;

                // 2. Popular o objeto appData com os dados recebidos
                appData = {
                    clients: clientsRes.data,
                    statuses: statusesRes.data,
                    users: usersRes.data,
                    tags: tagsRes.data,
                    client_tags: clientTagsRes.data,
                    tasks: tasksRes.data,
                    tickets: ticketsRes.data
                };

                // 3. Esconder a tela de carregamento e mostrar o app
                loadingScreen.classList.add('hidden');
                crmApp.classList.remove('hidden');
                
                // 4. Configurar a UI com os dados recebidos
                setupFilterLogic();
                setupUserMenu();
                setupViewToggle();
                applyFiltersAndRender();
                
                // 5. INICIAR O REALTIME!
                setupRealtimeSubscriptions();

            } catch (error) {
                loadingScreen.classList.add('hidden');
                crmApp.classList.remove('hidden');
                kanbanBoard.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg"><b>Erro ao carregar dados do Supabase:</b> ${error.message}</div>`;
                console.error("Erro na inicialização:", error);
            }
        }
        
        // --- LÓGICA DE TEMPO REAL (REALTIME) DO SUPABASE ---
        function setupRealtimeSubscriptions() {
            console.log("Configurando inscrições de tempo real...");

            dbClient.channel('public-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'CLIENTES' }, payload => {
                    console.log('Alteração em CLIENTES:', payload);
                    handleRealtimeChange(payload, 'clients', 'id_cliente');
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'TAREFAS' }, payload => {
                    console.log('Alteração em TAREFAS:', payload);
                    handleRealtimeChange(payload, 'tasks', 'id_tarefa');
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'TICKETS' }, payload => {
                    console.log('Alteração em TICKETS:', payload);
                    handleRealtimeChange(payload, 'tickets', 'id_ticket');
                })
                 .on('postgres_changes', { event: '*', schema: 'public', table: 'CLIENTE_TAGS' }, payload => {
                    console.log('Alteração em CLIENTE_TAGS:', payload);
                    // Para CLIENTE_TAGS, a chave é composta, então o tratamento é um pouco diferente
                    const { eventType, new: newRecord, old: oldRecord } = payload;
                    switch (eventType) {
                        case 'INSERT':
                            appData.client_tags.push(newRecord);
                            break;
                        case 'DELETE':
                            appData.client_tags = appData.client_tags.filter(ct => 
                                !(ct.id_cliente === oldRecord.id_cliente && ct.id_tag === oldRecord.id_tag)
                            );
                            break;
                    }
                    applyFiltersAndRender();
                })
                .subscribe();
        }

        function handleRealtimeChange(payload, appDataKey, idKey) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            switch (eventType) {
                case 'INSERT':
                    appData[appDataKey].push(newRecord);
                    break;
                case 'UPDATE':
                    const indexToUpdate = appData[appDataKey].findIndex(item => item[idKey] === newRecord[idKey]);
                    if (indexToUpdate !== -1) {
                        appData[appDataKey][indexToUpdate] = newRecord;
                    } else {
                        // Se não encontrar, pode ser um novo item para este cliente
                        appData[appDataKey].push(newRecord);
                    }
                    break;
                case 'DELETE':
                    const oldId = oldRecord[idKey];
                    appData[appDataKey] = appData[appDataKey].filter(item => item[idKey] !== oldId);
                    break;
            }

            // Re-renderiza a UI para refletir a mudança
            applyFiltersAndRender();
        }


        // --- LÓGICA DE FILTRAGEM E RENDERIZAÇÃO ---
        function getFilteredClients() {
            let filteredClients = appData.clients;

            if (activeTagId) {
                const clientIdsWithTag = appData.client_tags
                    .filter(ct => ct.id_tag === activeTagId)
                    .map(ct => ct.id_cliente);
                
                filteredClients = appData.clients.filter(client => clientIdsWithTag.includes(client.id_cliente));
            }

            const searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm.length >= 3) {
                filteredClients = filteredClients.filter(client => 
                    client.nome_empresa.toLowerCase().includes(searchTerm)
                );
            }
            return filteredClients;
        }

        // UPGRADE: Função principal de renderização agora decide qual view mostrar
        function applyFiltersAndRender() {
            // Atualiza os contadores de badges nos modais
            if (!clientModal.classList.contains('hidden')) {
                const clientId = document.getElementById('modal-form')?.dataset.clientId;
                if(clientId) {
                    updateModalBadges(clientId);
                }
            }
            
            if (currentView === 'kanban') {
                const clientList = getFilteredClients();
                renderBoard(clientList);
            } else {
                renderListView();
            }
        }

        function setupFilterLogic() {
            const filterContainer = document.getElementById('filter-container');
            const triggerBtn = document.getElementById('filter-trigger-btn');
            const popup = document.getElementById('filter-popup');
            const optionsContainer = document.getElementById('filter-options-container');
            const btnText = document.getElementById('filter-btn-text');

            optionsContainer.innerHTML = ''; // Limpa opções antigas

            if (appData.tags) {
                appData.tags.forEach(tag => {
                    const option = document.createElement('a');
                    option.href = '#';
                    option.className = 'filter-tag-option text-gray-700 block px-4 py-2 text-sm';
                    option.dataset.tagId = tag.id_tag;
                    option.dataset.tagName = tag.nome_tag;
                    option.dataset.tagColor = tag.cor;
                    
                    option.innerHTML = `
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full mr-3" style="background-color: ${tag.cor};"></span>
                            <span>${tag.nome_tag}</span>
                        </div>
                    `;

                    option.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = e.currentTarget;
                        activeTagId = target.dataset.tagId;

                        btnText.textContent = target.dataset.tagName;
                        triggerBtn.style.backgroundColor = `${target.dataset.tagColor}20`;
                        triggerBtn.style.color = target.dataset.tagColor;
                        triggerBtn.style.borderColor = target.dataset.tagColor;
                        triggerBtn.dataset.activeTagId = activeTagId;

                        popup.classList.add('hidden');
                        applyFiltersAndRender();
                    });
                    optionsContainer.appendChild(option);
                });
            }

            triggerBtn.addEventListener('click', () => {
                if (triggerBtn.dataset.activeTagId) {
                    activeTagId = null;
                    triggerBtn.dataset.activeTagId = '';
                    btnText.textContent = 'TODOS';
                    triggerBtn.style.backgroundColor = 'white';
                    triggerBtn.style.color = '#374151';
                    triggerBtn.style.borderColor = '#D1D5DB';
                    applyFiltersAndRender();
                } else {
                    popup.classList.toggle('hidden');
                }
            });
        }
        
        function setupUserMenu() {
            const userMenuContainer = document.getElementById('user-menu-container');
            const userAvatarBtn = document.getElementById('user-avatar-btn');
            const logoutPopup = document.getElementById('logout-popup');
            const popupLogoutBtn = document.getElementById('popup-logout-btn');

            userAvatarBtn.addEventListener('click', () => {
                logoutPopup.classList.toggle('hidden');
            });

            popupLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                logoutPopup.classList.add('hidden');
                showLogin();
            });

            document.addEventListener('click', (e) => {
                if (!userMenuContainer.contains(e.target)) {
                    logoutPopup.classList.add('hidden');
                }
                 if (!document.getElementById('filter-container').contains(e.target)) {
                      document.getElementById('filter-popup').classList.add('hidden');
                 }
            });
        }

        searchInput.addEventListener('input', applyFiltersAndRender);

        // --- RENDERIZAÇÃO DO QUADRO KANBAN ---
        function renderBoard(clientList = []) {
            kanbanBoard.innerHTML = '';
            appData.statuses.sort((a, b) => a.ordem - b.ordem).forEach(status => {
                const column = document.createElement('div');
                column.className = 'kanban-column bg-slate-100 rounded-lg p-3 w-[90vw] md:w-80 flex-shrink-0 transition-all duration-300';
                const clientsInStatus = clientList.filter(c => c.status === status.nome_status);
                
                const initialClients = clientsInStatus.slice(0, CARDS_TO_SHOW_INITIAL);

                column.innerHTML = `
                    <div class="column-header-expanded flex justify-between items-center mb-3 flex-shrink-0">
                        <div class="flex items-center min-w-0"><h2 class="font-bold text-gray-700 truncate">${status.nome_status}</h2><span class="ml-2 bg-slate-200 text-slate-600 text-sm font-semibold rounded-full px-2">${clientsInStatus.length}</span></div>
                        <button class="collapse-btn text-gray-400 hover:text-gray-600"><i class="fa-solid fa-angles-left"></i></button>
                    </div>
                    <div class="column-header-collapsed hidden flex-col items-center justify-between h-full flex-shrink-0">
                        <div class="vertical-text font-bold text-gray-700">${status.nome_status}</div><span class="bg-slate-200 text-slate-600 text-sm font-semibold rounded-full w-6 h-6 flex items-center justify-center mb-2">${clientsInStatus.length}</span>
                        <button class="collapse-btn text-gray-400 hover:text-gray-600"><i class="fa-solid fa-angles-left"></i></button>
                    </div>
                    <div class="kanban-cards min-h-[100px]" data-status-name="${status.nome_status}"></div>`;
                
                const cardsContainer = column.querySelector('.kanban-cards');
                
                initialClients.forEach(client => cardsContainer.appendChild(createClientCard(client)));
                
                kanbanBoard.appendChild(column);

                if (clientsInStatus.length > CARDS_TO_SHOW_INITIAL) {
                    attachLazyLoad(cardsContainer, clientsInStatus);
                }
            });
            initializeDragAndDrop();
            initializeColumnControls();
        }

        function attachLazyLoad(container, allClients) {
            let renderedCount = container.children.length;
            container.addEventListener('scroll', () => {
                if (container.dataset.loading === 'true') return;
                if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
                    if (renderedCount < allClients.length) {
                        container.dataset.loading = 'true';
                        const nextBatch = allClients.slice(renderedCount, renderedCount + CARDS_TO_LOAD_MORE);
                        nextBatch.forEach(client => container.appendChild(createClientCard(client)));
                        renderedCount += nextBatch.length;
                        setTimeout(() => { container.dataset.loading = 'false'; }, 100);
                    }
                }
            });
        }
        
        function initializeColumnControls() {
            document.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { e.stopPropagation(); btn.closest('.kanban-column').classList.toggle('collapsed'); });
            });
            document.querySelectorAll('.kanban-column').forEach(column => {
                column.addEventListener('click', (e) => { if(column.classList.contains('collapsed')) { column.classList.remove('collapsed'); } })
            })
        }

        function formatTimeRemaining(dueDateString) {
            if (!dueDateString) return { text: 'Sem prazo', colorClass: 'text-gray-500', pulse: false };
            const dueDate = new Date(dueDateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(23, 59, 59, 999); // Considera o dia todo do prazo
            const diffTime = dueDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return { text: 'Atrasado', colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays === 0) return { text: 'Hoje', colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays <= 3) return { text: `Faltam ${diffDays} dias`, colorClass: 'text-red-500 font-semibold', pulse: true };
            if (diffDays <= 7) return { text: `Faltam ${diffDays} dias`, colorClass: 'text-yellow-600 font-semibold', pulse: false };
            return { text: `Faltam ${diffDays} dias`, colorClass: 'text-gray-500', pulse: false };
        }

        function createClientCard(client) {
            const card = document.createElement('div');
            card.className = 'kanban-card bg-white rounded-lg p-4 mb-3 border border-gray-200 hover:border-green-400 hover:shadow-md cursor-pointer transition-all';
            card.dataset.clientId = client.id_cliente;

            const clientTags = (appData.client_tags || []).filter(ct => ct.id_cliente === client.id_cliente).map(ct => (appData.tags || []).find(t => t.id_tag === ct.id_tag)).filter(Boolean);
            const tagsHtml = clientTags.map(tag => `<span class="text-xs font-medium mr-1 mb-1 px-2 py-0.5 rounded-full" style="background-color:${tag.cor}20; color:${tag.cor};">${tag.nome_tag}</span>`).join('');
            
            const progress = calculateProgress(client.id_cliente);

            const clientTasks = appData.tasks ? appData.tasks.filter(t => t.id_cliente === client.id_cliente && !t.concluido && t.prazo_final) : [];
            clientTasks.sort((a, b) => new Date(a.prazo_final) - new Date(b.prazo_final));
            const nextTask = clientTasks[0];

            let nextTaskHtml;
            
            if (nextTask) {
                const timeInfo = formatTimeRemaining(nextTask.prazo_final);
                nextTaskHtml = `
                    <div class="mt-3 pt-3 border-t border-gray-100 group relative cursor-pointer" data-task-id="${nextTask.id_tarefa}">
                        <div class="absolute inset-0 bg-green-100 opacity-0 group-hover:opacity-100 transition-opacity rounded-md hidden md:flex items-center justify-center">
                            <span class="text-green-700 font-bold"><i class="fas fa-check mr-2"></i>Marcar como concluída?</span>
                        </div>
                        <p class="text-xs text-gray-400 font-semibold uppercase">Próxima Tarefa</p>
                        <div class="flex items-center justify-between mt-2">
                            <div class="break-words w-full pr-2">
                                <span class="text-sm text-gray-700 font-medium">${nextTask.titulo_tarefa}</span>
                                <p class="text-sm mt-1 ${timeInfo.colorClass} ${timeInfo.pulse ? 'pulse-animation' : ''}">${timeInfo.text}</p>
                            </div>
                            <div class="user-avatar-placeholder w-8 h-8 flex-shrink-0"></div>
                        </div>
                    </div>
                `;
            } else {
                nextTaskHtml = `<div class="text-sm text-gray-400 mt-3 pt-3 border-t border-gray-100">Nenhuma tarefa pendente com prazo.</div>`;
            }

            card.innerHTML = `
                <h3 class="font-semibold text-gray-800 truncate">${client.nome_empresa}</h3>
                <p class="text-sm text-gray-500 mb-3"><i class="fas fa-user mr-2 text-gray-400"></i>${client.nome_responsavel}</p>
                <div class="flex flex-wrap gap-y-1 mb-3">${tagsHtml}</div>
                <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${progress}%"></div></div>
                ${nextTaskHtml}
            `;

            // Programmatically create and append avatar to avoid innerHTML issues
            const avatarPlaceholder = card.querySelector('.user-avatar-placeholder');
            if (avatarPlaceholder && nextTask) {
                const responsibleUser = appData.users.find(u => u.id_usuario === nextTask.responsavel_id);
                
                if (responsibleUser) {
                    const userInitial = responsibleUser.nome_usuario ? responsibleUser.nome_usuario.charAt(0).toUpperCase() : '?';
                    
                    const fallbackAvatar = document.createElement('div');
                    fallbackAvatar.className = 'w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 font-bold';
                    fallbackAvatar.title = responsibleUser.nome_usuario;
                    fallbackAvatar.textContent = userInitial;

                    if (responsibleUser.foto_url) {
                        const avatarImg = document.createElement('img');
                        avatarImg.src = responsibleUser.foto_url;
                        avatarImg.crossOrigin = "anonymous";
                        avatarImg.referrerPolicy = "no-referrer";
                        avatarImg.className = 'w-8 h-8 rounded-full flex-shrink-0 object-cover';
                        avatarImg.title = responsibleUser.nome_usuario;
                        avatarImg.onerror = () => {
                            avatarPlaceholder.innerHTML = ''; // Clear placeholder in case of error
                            avatarPlaceholder.appendChild(fallbackAvatar);
                        };
                        avatarPlaceholder.appendChild(avatarImg);
                    } else {
                        avatarPlaceholder.appendChild(fallbackAvatar);
                    }
                } else {
                    avatarPlaceholder.innerHTML = `<div class="w-8 h-8 rounded-full bg-gray-200 flex-shrink-0 flex items-center justify-center text-gray-400 text-xs" title="Sem responsável"><i class="fas fa-user"></i></div>`;
                }
            }
            
            card.addEventListener('click', (e) => { e.stopPropagation(); showClientModal(client.id_cliente); });
            
            const quickCompleteContainer = card.querySelector('.group[data-task-id]');
            if (quickCompleteContainer) {
                if (window.innerWidth >= 768) {
                    quickCompleteContainer.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handleToggleTask(e.currentTarget.dataset.taskId, true);
                        showToast('Tarefa concluída!');
                    });
                }
            }
            return card;
        }

        // --- LÓGICA DO DRAG-AND-DROP (Atualizada para Supabase) ---
        function initializeDragAndDrop() {
            document.querySelectorAll('.kanban-cards').forEach(column => {
                new Sortable(column, {
                    group: 'kanban', animation: 150, delay: 200, delayOnTouchOnly: true, 
                    onEnd: async (evt) => {
                        const { item, to, from } = evt;
                        const clientId = item.dataset.clientId;
                        const newStatus = to.dataset.statusName;
                        
                        // Otimista: Atualiza a UI primeiro
                        const client = appData.clients.find(c => c.id_cliente.toString() === clientId);
                        if (client) {
                            client.status = newStatus;
                            updateColumnHeaders();
                        }
                        
                        try {
                            // Atualiza no Supabase
                            const { error } = await dbClient
                                .from('CLIENTES')
                                .update({ status: newStatus })
                                .eq('id_cliente', clientId);

                            if (error) throw error;
                            
                            // A chamada ao webhook pode ser feita aqui ou, idealmente, por uma Supabase Function
                            // await dbClient.functions.invoke('send-webhook', { body: { event: 'client_status_updated', ... } });

                        } catch (error) {
                            showToast('Erro ao atualizar status.');
                            // Reverte a mudança na UI em caso de erro
                            const client = appData.clients.find(c => c.id_cliente.toString() === clientId);
                            if (client) {
                                client.status = from.dataset.statusName;
                            }
                            // Move o card de volta visualmente
                            from.appendChild(item);
                            updateColumnHeaders();
                            console.error("Erro ao mover card:", error);
                        }
                    }
                });
            });
        }


        // --- RESTANTE DO CÓDIGO (A SER ADAPTADO) ---
        // As funções abaixo ainda usam a lógica antiga e precisam ser migradas
        // para usar o `dbClient` do Supabase, similar ao que foi feito
        // em `loginForm`, `initializeApp` e `initializeDragAndDrop`.

        // --- UPGRADE: LÓGICA DA NOVA VISÃO DE LISTA ---
        function setupViewToggle() {
            // ... (código original, sem alterações imediatas)
        }

        function populateListViewFilters() {
            // ... (código original, sem alterações imediatas)
        }

        function renderListView() {
            // ... (código original, precisa adaptar os nomes dos campos para o padrão do supabase, ex: TituloTarefa -> titulo_tarefa)
        }
        
        function handleQuickComplete(event, itemType, itemId) {
            // ... (precisa ser adaptado para Supabase)
        }

        function itemTypeLabel(type) {
            // ... (código original, sem alterações)
        }

        // --- Lógica do PWA ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (código original, sem alterações imediatas)
        });

        window.addEventListener('beforeinstallprompt', (e) => {
            // ... (código original, sem alterações)
        });
        
        // --- FUNÇÕES DE LÓGICA (MODAL, TAREFAS, TICKETS, ETC.) ---
        
        function calculateProgress(clientId) {
            // ... (precisa adaptar os nomes dos campos)
        }
        
        function showClientModal(clientId, onReadyCallback = null) {
            // ... (precisa ser adaptado para Supabase, nomes dos campos e chamadas de save/update)
        }

        function hideClientModal() {
            // ... (código original, sem alterações imediatas)
        }
        
        function updateCardOnBoard(clientId) {
            // ... (código original, sem alterações imediatas)
        }
        
        function updateColumnHeaders() {
            // ... (código original, sem alterações imediatas)
        }

        function renderTaskList(clientId) {
            // ... (precisa ser adaptado para Supabase, nomes dos campos e chamadas de save/update)
        }

        function showTaskEditor(taskId) {
            // ... (precisa ser adaptado para Supabase)
        }

        function handleSaveTask(taskId) {
            // ... (precisa ser adaptado para Supabase)
        }

        function showNewTaskForm(clientId, parentId) {
            // ... (código original, sem alterações imediatas)
        }

        function handleCreateTask(clientId, parentId, title) {
            // ... (precisa ser adaptado para Supabase)
        }

        function handleToggleTask(taskId, isCompleted) {
            // ... (precisa ser adaptado para Supabase)
        }

        function handleDeleteTask(taskId) {
            // ... (precisa ser adaptado para Supabase)
        }

        // --- Lógica de Tickets ---
        function renderTicketList(clientId) {
            // ... (precisa ser adaptado para Supabase)
        }

        function showTicketEditor(ticketId) {
            // ... (precisa ser adaptado para Supabase)
        }

        function handleSaveTicket(ticketId) {
            // ... (precisa ser adaptado para Supabase)
        }

        function showNewTicketForm(clientId, parentId) {
            // ... (código original, sem alterações imediatas)
        }

        function handleCreateTicket(clientId, parentId, title) {
            // ... (precisa ser adaptado para Supabase)
        }

        function handleToggleTicket(ticketId, isCompleted) {
            // ... (precisa ser adaptado para Supabase)
        }

        function handleDeleteTicket(ticketId) {
            // ... (precisa ser adaptado para Supabase)
        }
        
        function handleSaveClient(clientId) {
            // ... (precisa ser adaptado para Supabase)
        }

        // --- LÓGICA DO NOVO MODAL DE EDIÇÃO ---
        function openItemEditorModal(event, itemType, itemId) {
            // ... (precisa ser adaptado para Supabase)
        }

        function closeItemEditorModal() {
            // ... (código original, sem alterações imediatas)
        }

        function saveItemFromEditor() {
            // ... (precisa ser adaptado para Supabase)
        }

        // --- Inicialização do App ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('crmUser');
            if (savedUser) { 
                currentUser = JSON.parse(savedUser); 
                showApp(true); 
            } else { 
                showLogin(); 
            }
            clientModal.addEventListener('click', (e) => { if (e.target === clientModal) hideClientModal(); });
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'Escape') {
                    if (!document.getElementById('item-editor-modal').classList.contains('hidden')) {
                        closeItemEditorModal();
                    } else if (!clientModal.classList.contains('hidden')) {
                        hideClientModal();
                    }
                }
            });
        });

    </script>
</body>
</html>
